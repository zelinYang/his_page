<script type="text/javascript">
    var NO_FLAG = '$!{CONST.AppConstants.NO_FLAG}';
    var YES_FLAG = '$!{CONST.AppConstants.YES_FLAG}';
    var removeTrRecipeItem;//移除处方内容行
    var medicineRowSelect;//选择药品回调函数(库存药品)
    var addRecipeItemHistory;//添加历史处方明细项
    var addRecipeGroupItem;//选择组套回调函数 - 添加组套明细
    var saveTcmRecipe;//保存处方
    var addBasOrderGroup;//存组套
    var getOrderGroupItem;//获取组套明细数据
    var addNewRecipe;//新处方
    var delRecipe;//删处方
    var tcmDiagnosisRowSelect;//中医证型诊断列表名称 row选择回调
    var winClose;
    var _this;//用于保存$(this)
    var outpatientFlag = '$!{outpatientFlag}';
    var basDiseaseRowSelect;
    var basDicRowSelect;
    var getRecipeItemArray;
	var rationalDrugUseFlag = '$!{rationalDrugUseFlag}';
	var outMainWin = parent; //门诊医生主窗口页面对象
    var iframeIndex;// 窗体索引
    var _orderGroupNos;
    var _inhospitalId;
    var recipeId; //处方id
    // 3 草药
    var MEDICINE_TYPE_TCM_MEDICINE = "$!{CONST.AppConstants.MEDICINE_TYPE_TCM_MEDICINE}"

    var iframeSettings = {//医嘱名称内容propover 弹框参数
        width:600,
        height:350,
        closeable:false,
        padding:false,
        type:'iframe',
        url:'../outpatient/medicineTcmSelect.do'
    };


    var iframeDiagnosisSettings = {  //中医诊断内容propover 弹框参数
        width:700,
        height:350,
        closeable:false,
        padding:false,
        type:'iframe',
        url:'../outpatient/basDiseaseSelect.do?diseaseTypeFlag=$!{CONST.AppConstants.DICDISEASETYPEFLAG_CHINESE}&diseaseTypeNot=$!{CONST.AppConstants.DISEASE_TYPE_SYNDROME}'
    };

    var iframeTcmSymptomSettings = {  //诊断内容propover 弹框参数
        width:700,
        height:350,
        closeable:false,
        padding:false,
        type:'iframe',
        url:'../outpatient/tcmSymptomSelect.do'
    };

    function refreshParentTable() {
		var tcmRecipeIframe = $('div[lay-id=tcmRecipe] iframe',window.parent.document);
		$('#btn_refresh', tcmRecipeIframe.contents()).click();
    }


    layui.config({
        base: '../resource/layuiadmin/'
    }).extend({
        autocomplete: 'modules/autocomplete'
    }).use(['jquery','table', 'laypage','element','form', 'autocomplete'], function(){
        var layer = layui.layer, element = layui.element, laydate = layui.laydate, form = layui.form, tableSelect = layui.tableSelect, autocomplete = layui.autocomplete;
        element.render();


        autocomplete.render({
            cache: false,
            method: 'post',
            searchField: 'keyWord',
            elem: $('#tcmSymptom')[0],
            url: contextPath + '/basDic/selectTcmSymptom.jo',
            template_val: '{{d.dicName}}',
            template_txt: '{{d.dicName}}',
            onselect: function (obj) { $('#tcmSymptom').val(obj.dicName); }
        });

        /* 切换到指定Tab项 */
        tabChange = function (filter, layid) {
            element.tabChange(filter, layid);
        }

        //移除上级行
        removeTrRecipeItem = function (btnElem) {
            $(btnElem).parent().parent().remove();
        }


//medicineUsage 药品用法，获取值需要处理
        var dicProducingArea = JSON.parse('$dicTools.changeMapToJson($dicData.dicProducingArea)');
        var dicDrugNumUnitDosageUnit = JSON.parse('$dicTools.changeMapToJson($dicData.dicDrugNumUnitDosageUnit)');
        var firstMedicineTypeMaps = JSON.parse('$dicTools.changeMapToJson($firstMedicineTypeMaps)');
        var dicDrugNumUnit = JSON.parse('$dicTools.changeMapToJson($dicData.dicDrugNumUnit)'); //药品数量单位
        var dicHerbCooking = JSON.parse('$dicTools.changeMapToJson($dicData.dicHerbCooking)');//中药煎法

        //ctrl + S 保存
        document.onkeydown = function(e){
            var keyCode = e.keyCode || e.which || e.charCode;
            var altKey = e.altKey
            if(altKey && e.keyCode == 83){
                e.preventDefault()
                $('#btn_save').click();
            }
        };


        //中医证型诊断列表名称 row选择回调

        $(document).ready(function () {
            randerPlugins();//重新渲染插件
            initSearchMedicineNamePopover();
            initShowMedicineNamePopover();
            initShowBasDiseasePopover();
            initShowTcmSymptomPopover();
            initSearchBasDiseasePopover();
			initSearchTcmSymptomPopover();

            //保存并关闭处方
            $('#btn_save').click(function() {
                _this = $(this);
                saveTcmRecipe();
            });

            //保存处方
            $('#btn_submit').click(function() {
                _this = $(this);
                saveTcmRecipe();
            });

            //新增行
            $('#btn_add').click(function() {
                addTr();
            });

            $('.main-center').height($('#tcmRecipeForm').height() - $('.main_top').height() - $('.tool-bottom-fixed').height() - 15)
        });
        $(window).resize(function(){
            $('.main-center').height($('#tcmRecipeForm').height() - $('.main_top').height() - $('.tool-bottom-fixed').height() - 15)
        });

        //获取处方明细数据列表
		getRecipeItemArray = function(recipeParams) {
            var recipeItemArray = common.buildTrInputJSON($('.tbody-data'));
            $('.tbody-data tr').each(function(index, data) {
                recipeItemArray[index].herbCookingName = $(this).find('select[name=herbCookingCode]').find("option:selected").text();//备注-中药煎煮法
            });


            var medicineIds = [];
            $(recipeItemArray).each(function (index, data){
                var medicineId;
                medicineId = data.medicineId;
                data.usageQuantity = data.dosage;
                medicineIds.push(medicineId);
            });

            var medicineInfoArray = selectRecipeMedicineInfo(medicineIds.join(','));

            //转成map
            var isRecipeItem = true;
            var recipeItemMap = convertRecipeItemMap(recipeItemArray, isRecipeItem);
            recipeItemArray.length = 0;//清空数组

            var medicineStockShortage = []
            $(medicineInfoArray).each(function (index,mInfo) {
                var dosage = recipeItemMap[mInfo.medicineId].dosage;//明细的数量
                if (mInfo.stockCount < dosage) {
                    medicineStockShortage.push(recipeItemMap[mInfo.medicineId]);//添加库存不足的药品到数组
                    return true;//继续for循环
                } else {
                    recipeItemArray.push(recipeItemMap[mInfo.medicineId]);//添加有库存的药品到数组
                }
            });
            for (var i = 0; i < recipeItemArray.length; i++) {
                recipeItemArray[i].medicineFlag = recipeParams.medicineFlag;
                recipeItemArray[i].medicineType = recipeParams.medicineType;
                recipeItemArray[i].makeOrderFlag = recipeParams.makeOrderFlag;
                recipeItemArray[i].orderClassify = recipeParams.orderClassify;
                recipeItemArray[i].diseaseIcdTcd = recipeParams.diseaseIcdTcd;
                recipeItemArray[i].diseaseName = recipeParams.diseaseName;
                recipeItemArray[i].tcmSymptom = recipeParams.tcmSymptom;
                recipeItemArray[i].tcmSymptomName = recipeParams.tcmSymptomName;
                recipeItemArray[i].orderDay = recipeParams.orderDay;
            }
            var recipeItem = {
                recipeItemArray: recipeItemArray,
                medicineStockShortage: medicineStockShortage
            };

            return recipeItem;

        }

        getMedicineType = function() {
            return $("input[name='medicineType']:checked").val();
        }

        getOrderGroupItem = function() {
            var recipeItemArray = getRecipeItemArray();

            $('.tbody-data td > select ').each(function(index, data) {
                groupItem = {};
                groupItem.drugDosage = data.dosage;
                groupItem.drugQuantity = data.aa;
                groupItem.medicineSpec = data.medicineSpec;
                groupItem.exeOfficeId = '';
                groupItem.groupFlag = '1';
                groupItem.orderFlag = '1';
                groupItem.medicineId = data.medicineId;
                groupItem.pharmacyId = data.pharmacyId;
                groupItem.orderName = data.orderName;
                groupItem.pharmacyFreqId = data.usageFrequencyCode;
                groupItem.doctorOrderType = data.medicineType;//项目类型
                groupItem.remark = data.remark;//单条说明
                groupItem.showSort = data.index;//单条说明
                //groupItem.specialRemark = data.index;// 特殊说明，(整组说明)
                groupItem.doseWayCode = data.medicineUsage;// 用法，给药途径
            });
        }

        winClose = function () {
            var index = parent.layer.getFrameIndex(window.name);
            parent.layer.close(index);
        }

        //删处方
        function delRecipe() {
            var recipeId = $('#recipeId').val();
            if (!recipeId) {
                common.alert('处方不存在！', 0);
                return false;
            }
            common.requestServer('$contextPath/outpatient/delRecipe.jo', {recipeId:$('#recipeId').val()}, function(result){
                if (result.code == "0") {
                    common.alertCall(result.msg, 1, function (){
                        //新处方
                        addNewRecipe();
                    });
                } else {
                    common.alert(result.msg, 0);
                }
            });
        }

        //新处方
        function addNewRecipe() {
            window.location.href="../outpatient/recipeTcmEdit.do" ;
        }


        function addBasOrderGroup() {
            common.open('$contextPath/outpatient/basOrderGroupMedicineEdit.do', '新增组套', {area: ['800px', '600px']});
        }

//显示Popover
        function initShowMedicineNamePopover() {
            var inputBoxList = $(".tbody-data tr td input[name=orderName]");
            inputBoxList.each(function(index) {
                var elem = $(this);
                elem.webuiPopover('destroy').webuiPopover($.extend({},iframeSettings));
            });
        }

        //绑定显示Popover
        function bindShowMedicineNamePopover(elem) {
            elem.webuiPopover('destroy').webuiPopover($.extend({},iframeSettings));
        }

        //初始化搜索Popover
        function initSearchMedicineNamePopover() {
            $('input[name=orderName]').on('input propertychange', function (){
                var popoverId = $(this).attr('data-target');
                $('#'+popoverId+' iframe').contents().find("#keyWord").val($(this).val());//获取iframe的内容
                $('#'+popoverId+' iframe')[0].contentWindow.queryPharmacyStock(); //调用iframe的方法
            });
        }

        //bind搜索Popover
        function bindSearchMedicineNamePopover(elem) {
            elem.on('input propertychange', function (){
                var popoverId = $(this).attr('data-target');
                $('#'+popoverId+' iframe').contents().find("#keyWord").val($(this).val());//获取iframe的内容
                $('#'+popoverId+' iframe')[0].contentWindow.queryPharmacyStock(); //调用iframe的方法
            });
        }


        //显示Popover
        function initShowBasDiseasePopover() {
            var inputBoxList = $("#diseaseName");
            inputBoxList.each(function(index) {
                var elem = $(this);
                elem.webuiPopover('destroy').webuiPopover($.extend({},iframeDiagnosisSettings));
            });
        }

        function initShowTcmSymptomPopover() {
            var inputBoxList = $("#tcmSymptomName");
            inputBoxList.each(function(index) {
                var elem = $(this);
                elem.webuiPopover('destroy').webuiPopover($.extend({},iframeTcmSymptomSettings));
            });
        }

        //绑定显示Popover
        function bindShowBasDiseasePopover(elem) {
            elem.webuiPopover('destroy').webuiPopover($.extend({},iframeDiagnosisSettings));
        }

        //初始化搜索BasDisease Popover
        function initSearchBasDiseasePopover() {
            $('#diseaseName').on('input propertychange', function (){
                var popoverId = $(this).attr('data-target');
                $('#'+popoverId+' iframe').contents().find("#keyWord").val($(this).val());//获取iframe的内容
                $('#'+popoverId+' iframe')[0].contentWindow.query(); //调用iframe的方法
            });
        }

        //初始化搜索TcmSymptom Popover
        function initSearchTcmSymptomPopover() {
			$('#tcmSymptomName').on('input propertychange', function (){
                var popoverId = $(this).attr('data-target');
                $('#'+popoverId+' iframe').contents().find("#keyWord").val($(this).val());//获取iframe的内容
                $('#'+popoverId+' iframe')[0].contentWindow.query(); //调用iframe的方法
            });
        }

        basDiseaseRowSelect = function (basDisease) {
            WebuiPopovers.hideAll();
            $('#diagnosisId').val(basDisease.diagnosisId);
            $('#diseaseName').val(basDisease.diseaseName);
            $('#diseaseTypeFlag').val(1);
            $('#diseaseIcdTcd').val(basDisease.diseaseIcdTcd);
            $('#diagnosisDescFlag').val(basDisease.diseaseName);
            $('#diagnosisFlag').val(1);
        }

        basDicRowSelect = function (basDic) {
            console.log(basDic);
            WebuiPopovers.hideAll();
            $('#tcmSymptom').val(basDic.dicCode);
            $('#tcmSymptomName').val(basDic.dicName);
        };


        //保存数据到页面
        saveTcmRecipe = function() {
            var illegalRules = 0;//非法规则
            var re =  /^\+?[1-9][0-9]*$/; //正则

            var recipeParams = getTcmRecipeFormParam();
            //参数设置
            var recipeItem = getRecipeItemArray(recipeParams);

            var medicineStockShortage = recipeItem.medicineStockShortage;//表格中库存不组的药品
            var recipeItemArray = recipeItem.recipeItemArray;

            if (!recipeParams.herbUsageWay) {
                common.msg('请选择用法！', 0);
                return false;
            }

            if (!recipeParams.orderDay) {
                common.msg('请选择剂数！', 0);
                return false;
            }
			recipeParams.takeBoilFlag = $("#takeBoilFlag").is(":checked")? '1': '0';
			recipeParams.pasteProcessingFlag = $("#pasteProcessingFlag").is(":checked")? '1': '0';
            //提示库存不足的药品
            if(medicineStockShortage.length > 0){
                var orderNames = '';
                $(medicineStockShortage).each(function(index, data) {
                    orderNames += data.orderName + ',';
                });
                orderNames = common.clearLastChar(orderNames,',');
                common.alert(orderNames + '库存不足', 0);
                return false;
            }

            //验证处方药品内容
            if(!validRecipeItem(recipeItemArray)){
                return false;
            }

            $(recipeItemArray).each(function(index, data) {
                if(!re.test(data.dosage)){
                    common.alert('请输入正确的剂量格式', 0);
                    illegalRules++;
                    return false;
                }
            });

            if(illegalRules > 0) return false;//如果剂量不符合格式不保存

            calculateTheTotalPrice(recipeParams.orderDay, recipeItemArray);
            recipeParams.recipeItemEditInfoList = recipeItemArray;
            recipeParams.inpatientOrderJson = JSON.stringify(recipeItemArray);
            console.log(recipeParams);
            if (outpatientFlag === '1') {
                saveOutpatientRecipe(recipeParams);
            } else {
                recipeParams.orderGroupNos = recipeParams.orderGroupNo;
                saveInpatientOrder(recipeParams);
            }
        };//save function

        function saveOutpatientRecipe(recipeParams) {
            var btnId = _this.attr("id");//获取当前点击的buttonId
            var emrIframe =  $('div[lay-id=outpatientEmr] iframe',window.parent.document);
            var emrEditWin = emrIframe.contents().find('iframe')[0].contentWindow;
            var registerId = recipeParams.registerId;
            common.openLoad();
            $.ajax({
                type:"POST",
                dataType:"json",
                contentType: 'application/json;charset=utf-8',
                url: "$contextPath/outpatient/saveTcmRecipe.jo",
                data:JSON.stringify(recipeParams),
                success:function(result){
                    if (result.code === '0') {
                        ## common.msg('保存成功。', 1, function () {
                            //location.reload()
                            var recipe = result.data;
                            recipeId = recipe.recipeId;
                            $('#recipeId').val(recipe.recipeId);//处方id
                            $('#recipeNum').val(recipe.recipeNum);//处方号码
                            $('#medicineType').val(recipe.medicineType);
                            //设置处方明细 recipeItemId
                            $('.tbody-data tr').each(function (index, data) {
                                var trItem = $(this);
                                var medicineId = trItem.find('input[name="medicineId"]').val();
                                $(recipe.recipeItemList).each(function (i,recipeItem) {
                                    if(medicineId == recipeItem.medicineId){
                                        trItem.find('input[name="recipeItemId"]').val(recipeItem.recipeItemId);
										trItem.find('input[name="pharmacyStockId"]').val(recipeItem.pharmacyStockId);
                                    }
                                });
                                $(this).find('.layui-icon-ok').removeClass('layui-hide');
                                $(this).find('.layui-icon-delete').addClass('layui-hide');
                            });

						refreshParentTable();
						emrEditWin.getEmrRecipeTcmItem(registerId);
                            //如果当前点击的是保存并关闭 则保存后关闭窗口
//                            if(btnId == "btn_save"){
                                //winClose();
 //                           }
						if (rationalDrugUseFlag === '1') { // 是否启用合理用药
 	                        common.requestServer('$contextPath/rationalDrugUse/outpatientRecipeAudit.jo',
                                {registerId: outMainWin.grobalModel.registerId, medicineType: MEDICINE_TYPE_TCM_MEDICINE, recipeId: recipeId}, function (result) {
                                common.closeLoad();
                                if (result.code == "0") {
                                    if (result.data.type.indexOf('recloud') > -1) { // 进入瑞思云审核
                                        var data = $.parseJSON(result.data.result);
                                        console.log(data);
                                         if (data.success && (data.code == '1' || data.code == '2')) {
                                             common.openLoad();
                                             common.requestServer('$contextPath/rationalDrugUse/outpatientRecipeApproved.jo', {registerId: outMainWin.grobalModel.registerId, medicineType: MEDICINE_TYPE_TCM_MEDICINE, recipeId: recipeId}, function (result) {
                                                 common.closeLoad();
                                                 if (result.code == "0") {
                                                     common.alertCall("审核通过，保存成功", 1, function () {
                                                         if (refreshParentTable) {
                                                             refreshParentTable();
                                                         }
                                                         winClose();
                                                     });
                                                 } else {
                                                     common.alert(result.msg, 0);
                                                 }
                                             });
                                         } else if (data.success && data.code == '0') {
                                             var url = data.data.url.replaceAll("prescription.html", "doctorPrescription.html");
                                             iframeIndex = common.open(url, '处方药品审核结果', {area: ['90%', '90%'], scroll: 'scroll'});
                                             window.addEventListener('message', eventListener);
                                         } else {
                                             common.alert(data.msg, 0);
                                         }
                                    }  else if (result.data.type.indexOf('ninghao') > -1) {
                                        common.openLoad();
                                        common.requestServer('$contextPath/rationalDrugUse/outpatientRecipeApproved.jo', {registerId: outMainWin.grobalModel.registerId, medicineType: MEDICINE_TYPE_TCM_MEDICINE, recipeId: recipeId}, function (result) {
                                            common.closeLoad();
                                            if (result.code == "0") {
                                                common.alertCall("审核通过，保存成功", 1, function () {
                                                    if (refreshParentTable) {
                                                        refreshParentTable();
                                                    }
                                                    winClose();
                                                });
                                            } else {
                                                common.alert(result.msg, 0);
                                            }
                                        });
                                    }
                                } else {
                                    common.alert(result.msg, 0);
                                }
                            });
						} else {
							outMainWin.countOutpatientFee(outMainWin.grobalModel.registerId);
							window.location.reload();
							common.closeLoad();
						}

                        ## })
                    } else {
                        common.alert(result.msg, 0);
                        common.closeLoad();
                    }
                }
            }).error(function (e){jqueryPostError(e)});
        }

        //  瑞思云处方审核结果监听事件
        function eventListener(e) {
            console.log(e.data);
            window.removeEventListener('message', eventListener);
            if (e.data == '1') {
                common.openLoad();
                if (outpatientFlag == 1) {
                    common.requestServer('$contextPath/rationalDrugUse/outpatientRecipeApproved.jo', {registerId: outMainWin.grobalModel.registerId, medicineType: MEDICINE_TYPE_TCM_MEDICINE,recipeId: recipeId}, function (result) {
                        common.closeLoad();
                        if (result.code == "0") {
                            common.alertCall("审核通过，保存成功", 1, function () {
                                if (refreshParentTable) {
                                    refreshParentTable();
                                }
                                winClose();
                            });
                        } else {
                            common.alert(result.msg, 0);
                        }
                    });
                } else {
                    common.requestServer('$contextPath/rationalDrugUse/inpatientRecipeApproved.jo', {
                        inhospitalId: _inhospitalId,
                        orderGroupNos: _orderGroupNos
                    }, function (result) {
                        common.closeLoad();
                        if (result.code == "0") {
                            common.alertCall("审核通过，保存成功", 1, function () {
                                $('.tbody-data tr').each(function (index, data) {
                                    $(this).find('.layui-icon-ok').removeClass('layui-hide');
                                    $(this).find('.layui-icon-delete').addClass('layui-hide');
                                });
                                $('#btn_refresh', parent.document).click();
                                winClose();
                            });
                        } else {
                            common.alert(result.msg, 0);
                        }
                    });
                }
            } else if (e.data == '0') {
                layer.close(iframeIndex);
            }
        }

        function saveInpatientOrder(recipeParams) {
            var btnId=_this.attr("id");//获取当前点击的buttonId
            common.requestServer('$contextPath/inpatient/saveOrderForMedicine.jo', recipeParams, function (result) {
                if (result.code == "0") {
                    var orderList = result.data;
                    $('.tbody-data tr').each(function (index, data) {
                        // $(this).find('.layui-icon-ok').removeClass('layui-hide');
                        // $(this).find('.layui-icon-delete').addClass('layui-hide');
                        $(this).find('input[name = "orderId"] ').val(orderList[index].orderId);
                    });
                    $('#btn_refresh', parent.document).click();
                    if (rationalDrugUseFlag === '1') { // 是否启用合理用药
                        _orderGroupNos = recipeParams.orderGroupNo;
                        _inhospitalId =  recipeParams.inhospitalId;
                        common.requestServer('$contextPath/rationalDrugUse/inpatientRecipeAudit.jo',
                        {
                            inhospitalId: _inhospitalId,
                            orderGroupNos: _orderGroupNos
                        }, function (result) {
                            common.closeLoad();
                            if (result.code == "0") {
                                if (result.data.type.indexOf('recloud') > -1) { // 进入瑞思云审核
                                    var data = $.parseJSON(result.data.result);
                                    // console.log(data,864356);
                                    // iframeIndex = common.open('http://fat.ppt.web.recloud.cn/his/prescription/doctorPrescription.html?prescriptionId=56C43DD0-B87B-42D8-BBFF-9A18923E5C05', '处方药品审核结果', {area: ['90%', '90%'], scroll: true});
                                    // window.addEventListener('message', eventListener);
                                     if (data.success && (data.code == '1' || data.code == '2')) {
                                         common.openLoad();
                                         common.requestServer('$contextPath/rationalDrugUse/inpatientRecipeApproved.jo', {
                                             inhospitalId: recipeParams.inhospitalId,
                                             orderGroupNos: _orderGroupNos
                                         }, function (result) {
                                             common.closeLoad();
                                             if (result.code == "0") {
                                                 common.alertCall("审核通过，保存成功", 1, function () {
                                                     $('.tbody-data tr').each(function (index, data) {
                                                         $(this).find('.layui-icon-ok').removeClass('layui-hide');
                                                         $(this).find('.layui-icon-delete').addClass('layui-hide');
                                                     });
                                                     $('#btn_refresh', parent.document).click();
                                                     winClose();
                                                 });
                                             } else {
                                                 common.alert(result.msg, 0);
                                             }
                                         });
                                     } else if (data.success && data.code == '0') {
                                         var url = data.data.url.replaceAll("prescription.html", "doctorPrescription.html");
                                         iframeIndex = common.open(url, '处方药品审核结果', {area: ['90%', '90%'], scroll: 'scroll'});
                                         window.addEventListener('message', eventListener);
                                     } else {
                                         common.alert(data.msg, 0);
                                     }
                                } else if (result.data.type.indexOf('ninghao') > -1) {
                                    common.openLoad();
                                    common.requestServer('$contextPath/rationalDrugUse/inpatientRecipeApproved.jo', {
                                        inhospitalId: recipeParams.inhospitalId,
                                        orderGroupNos: _orderGroupNos
                                    }, function (result) {
                                        common.closeLoad();
                                        if (result.code == "0") {
                                            common.alertCall("审核通过，保存成功", 1, function () {
                                                $('.tbody-data tr').each(function (index, data) {
                                                    $(this).find('.layui-icon-ok').removeClass('layui-hide');
                                                    $(this).find('.layui-icon-delete').addClass('layui-hide');
                                                });
                                                $('#btn_refresh', parent.document).click();
                                                winClose();
                                            });
                                        } else {
                                            common.alert(result.msg, 0);
                                        }
                                    });
                                }
                            } else {
                                common.alert(result.msg, 0);
                            }
                        });
                    } else {
                        common.closeLoad();
                        common.alertCall("保存成功。", 1, function () {
                            $('.tbody-data tr').each(function (index, data) {
                                $(this).find('.layui-icon-ok').removeClass('layui-hide');
                                $(this).find('.layui-icon-delete').addClass('layui-hide');
                            });
                            $('#btn_refresh', parent.document).click();
                            winClose();
                        });
                    }
                } else {
                    common.alert(result.msg, 0);
                }
            });
        }

        //计算药品总价
        function calculateTheTotalPrice(orderDay, recipeItemArray){
            $(recipeItemArray).each(function(i, v){
                v.actualPrice = v.unitPrice * v.dosage * orderDay;
            });
        }


        //获取表单参数
        function getTcmRecipeFormParam(){
            var tcmRecipeParams = {};
            var tcmRecipeFormParams = common.serializeObject($('#tcmRecipeForm'));
            tcmRecipeParams.recipeId = tcmRecipeFormParams.recipeId;
            tcmRecipeParams.registerId = tcmRecipeFormParams.registerId;
            tcmRecipeParams.patientId = tcmRecipeFormParams.patientId;
            tcmRecipeParams.medicineType = $('#medicineType').val();
            tcmRecipeParams.recipeNum = $('#recipeNum').val();
            tcmRecipeParams.patientName = $('#patientName').val();
            tcmRecipeParams.pharmacyId = $('#pharmacyId').val();
            tcmRecipeParams.herbUsageWay = tcmRecipeFormParams.herbUsageWay;
            tcmRecipeParams.orderDay = tcmRecipeFormParams.orderDay;
            tcmRecipeParams.usageFrequencyCode = tcmRecipeFormParams.usageFrequencyCode;
            tcmRecipeParams.recipeRemark = tcmRecipeFormParams.recipeRemark;
            tcmRecipeParams.takeBoilFlag = tcmRecipeFormParams.takeBoilFlag;
            tcmRecipeParams.recipeType = tcmRecipeFormParams.recipeType;
            tcmRecipeParams.herbUsageClassify = tcmRecipeFormParams.herbUsageClassify;
            tcmRecipeParams.diseaseIcdTcd = tcmRecipeFormParams.diseaseIcdTcd;
            tcmRecipeParams.diseaseName = tcmRecipeFormParams.diseaseName;
            tcmRecipeParams.tcmSymptom = tcmRecipeFormParams.tcmSymptom;
            tcmRecipeParams.tcmSymptomName = tcmRecipeFormParams.tcmSymptomName;
            tcmRecipeParams.inhospitalId = tcmRecipeFormParams.inhospitalId;
            tcmRecipeParams.makeOrderFlag = tcmRecipeFormParams.makeOrderFlag;
            tcmRecipeParams.medicineFlag = tcmRecipeFormParams.medicineFlag;
            tcmRecipeParams.orderClassify = tcmRecipeFormParams.orderClassify;
            tcmRecipeParams.orderGroupNo = tcmRecipeFormParams.orderGroupNo;
            return tcmRecipeParams;
        }

        function getDiseaseDiagnosisParams() {
            var diagnosisParams = {};
            var diagnosisFormParams = common.serializeObject($('#tcmRecipeForm'));
            diagnosisParams.diseaseIcdTcd = diagnosisFormParams.diseaseIcdTcd;
            diagnosisParams.diseaseId = diagnosisFormParams.diseaseId;
            diagnosisParams.diseaseTypeFlag = diagnosisFormParams.diseaseTypeFlag;
            diagnosisParams.diagnosisFlag = diagnosisFormParams.diagnosisFlag || NO_FLAG;
            diagnosisParams.diseaseName = diagnosisFormParams.diseaseName;
            diagnosisParams.registerId = diagnosisFormParams.registerId;
            diagnosisParams.patientId = diagnosisFormParams.patientId;
            diagnosisParams.diagnosisDescFlag = diagnosisFormParams.diagnosisDescFlag;
            return diagnosisParams;
        }

        //设置患者信息、就诊信息 参数
        function setPatientTreatInfo() {
            var formParamObj = {};
            var curPatient = parent.curPatient;
            formParamObj.patientId = curPatient.patientId;
            formParamObj.visitCardNo = curPatient.visitCardNo;
            formParamObj.patientName = curPatient.patientName;
            formParamObj.recipeAge = curPatient.patientYearAge;
            formParamObj.registerId = parent.grobalModel.registerId;
            formParamObj.outpatientId = parent.grobalModel.outpatientId;
            formParamObj.urgencyFlag = parent.grobalModel.urgencyFlag;
            return formParamObj;
        }

        //验证处方药品内容
        function validRecipeItem(recipeItemArray) {
            var pass = true;
            if (!recipeItemArray || recipeItemArray.length <=0) {
                common.alert('请添加药品', 0);
                return false;
            }
            if (recipeItemArray) {
                $(recipeItemArray).each(function(index) {
                    //选择药品
                    if (!this.medicineId) {
                        common.alert('第'+(index+1) +'行未选择药品', 0);
                        pass =  false; $('.tbody-data tr:eq('+index+')').click();
                        return false;//跳出循环
                    }
                    //每次剂量/用量
                    if (!this.dosageUnit || !this.dosage) {
                        common.alert('第'+(index+1) +'行请填写每次剂量/用量', 0);
                        pass =  false; $('.tbody-data tr:eq('+index+')').click();
                        return false;
                    }
                });
            }
            return pass;
        }


        function activeTrFun() {
            $('.tbody-data tr td input[name=orderName]').click(function() {
                $(this).parents('tr').addClass('active').siblings().removeClass('active');
            });
        }

        //选择药品回调函数(库存药品)
        medicineRowSelect = function(pharmacyStockRow) {
            WebuiPopovers.hideAll();
            var trActive = $('tr.active');
            var isExist = false;
            //验证是否存在相同药品
            $('.tbody-data tr').each(function () {
                var medicineId = $(this).find('input[name="medicineId"]').val();
                if(medicineId == pharmacyStockRow.medicineId){
                    isExist = true;
                    return false;
                }
            });

            if (isExist) {
                common.alert('所选药品已存在！', 0);
                return false;
            }
            //插入行数据
            addTrData(pharmacyStockRow, trActive);
        }


        //新增处方行
        function addTr(recipeItem){
            var newTr = $('.tplRow').clone();
            newTr.removeClass('tplRow');
            addTrData(recipeItem,newTr)
            bindShowMedicineNamePopover(newTr.find('input[name=orderName]'));
            bindSearchMedicineNamePopover(newTr.find('input[name=orderName]'));

            //如果存在新行，但未选择药品，不能新增行
            var unSlectMedicine =  $('.tbody-data tr input[name=medicineId][value=""]');
            if (unSlectMedicine.size() >= 1) {
                return false;
            }
            $('.tbody-data').append(newTr);

            randerPlugins();
        }

        //新增处方行数据
        function addTrData(recipeItem, elemTr){
            if (!recipeItem) {
                return false;
            }
            //插入行数据
            elemTr.find('input[name="medicineId"]').val(recipeItem.medicineId);//药品ID
            elemTr.find('input[name="pharmacyStockId"]').val(recipeItem.pharmacyStockId);//药品ID
            elemTr.find('input[name="orderName"]').val(recipeItem.medicineName);//药品名称
            elemTr.find('input[name="medicineSpec"]').val(recipeItem.medicineSpec);//规格
            //usageQuantity 药物使用-数量
            if (recipeItem.hasOwnProperty('usageQuantity')) {
                elemTr.find('input[name="usageQuantity"]').val(recipeItem.usageQuantity);//剂量单位
            }
            //dosage 每次使用剂量
            if (recipeItem.hasOwnProperty('dosage')) {
                elemTr.find('input[name="dosage"]').val(recipeItem.dosage);//剂量单位
            }
            elemTr.find('input[name="pharmacyId"]').val(recipeItem.pharmacyId);//药房id
            elemTr.find('input[name="dosageUnit"]').val(recipeItem.dosageUnit);//剂量单位
            elemTr.find('input[name="dosageUnitText"]').val(dicDrugNumUnitDosageUnit[recipeItem.dosageUnit]);//剂量单位
            elemTr.find('span[id="producingAreaIdText"]').text(dicProducingArea[recipeItem.producingAreaId]);// 药物使用-总数量  使用总量 =1
            elemTr.find('input[name="producingAreaId"]').val(recipeItem.producingAreaId);// 药物使用-总数量  使用总量 =1
            elemTr.find('input[name="unitPrice"]').val(recipeItem.minRetailPrice);
            elemTr.find('input[name="minRetailPrice"]').val(recipeItem.minRetailPrice);
            elemTr.find('input[name="retailPrice"]').val(recipeItem.retailPrice);
            elemTr.find('input[name=minMedicinePack]').val(recipeItem.minMedicinePack);
            elemTr.find('input[name=producingAreaId]').val(recipeItem.producingAreaId);
            elemTr.find('input[name=validUntil]').val(recipeItem.expireDate);
            elemTr.find('input[name=minMedicineUnit]').val(recipeItem.minMedicineUnit);
            elemTr.find('input[name=medicineUnit]').val(recipeItem.medicineUnit);
            elemTr.find('input[name=medicineType]').val(recipeItem.medicineType);
            if (recipeItem.medicineId) {
                common.requestServer('../medicine/getMedicineInfo.jo', {medicineId: recipeItem.medicineId}, function (result) {
                    if (result.code === '0') {
                        elemTr.find('input[name="inhospitalChargeGroupCode"]').val(result.data.medicine.inhospitalChargeGroupCode);
                        elemTr.find('input[name="docChargeGroupCode"]').val(result.data.medicine.docChargeGroupCode);
						elemTr.find('input[name=medicineRecipeClassify]').val(result.data.medicine.medicineRecipeClassify);
                    } else {
                        common.alert(result.msg, 0);
                    }
                });
            }
            elemTr.find('input[name="dosage"]').on('input propertychange change', function () {
                calcItemTotalPrice(elemTr);
            });
            calcItemTotalPrice(elemTr);
        }

        //改变剂数事件
        $("#orderDay").on('input propertychange change', function () {
            $('.tbody-data').children('tr').each(function () {
                calcItemTotalPrice($(this));
            })
        })

        //计算单行总价
        function calcItemTotalPrice(curTr) {
            var dosage = curTr.find('input[name="dosage"]').val() || 0;//每付剂量
            var unitPrice = curTr.find('input[name="unitPrice"]').val() || 0;//单价
            var orderDay = $("#orderDay").val() || 0;//剂数
            curTr.find('input[name="actualPrice"]').val(Number(unitPrice * dosage * orderDay).toFixed(2));
            countRecipeTotalPriceValue();
        }
        function countRecipeTotalPriceValue() {
            //获取草药总金额
            $('.recipeTotalPriceValue').text($.map($('.tbody-data').children('tr').find('input[name="actualPrice"]'), function (elem) {
                return Number($(elem).val() || 0);
            }).reduce(function (total, num) {
                return total + num;
            }, 0).toFixed(2));
        }
        countRecipeTotalPriceValue();
        //重新渲染插件
        function randerPlugins() {
            element.init();
            form.render();
            activeTrFun();//激活行
        }


        //删除处方
        function invalidRecipe() {
            var recipeId = $('#recipeId').val();
            if(!recipeId) {
                common.alert('处方不存在', 0);
                return false;
            }

            var result;
            $.ajax({
                type : "POST",
                url : '../outpatient/invalidRecipe.jo',
                data : {recipeId : recipeId},
                dataType : "json",
                async : false,//同步 请求
                success : function(data) {result = data;},
                error : function(res) {jqueryPostError(res);}
            });//ajax end

            if(result.code == '0') {
                common.alertCall("删除成功!", 1, function() {
                    parent.invalidRecipe(recipeId);
                });
            } else {
                common.alert(result.msg, 0);
            }
        }

        function activeNextTd(curTd) {
            var nextFocusElem = curTd.nextAll().find('input,.layui-unselect').not('[readonly]').not('[type^=hidden]').first();
            if (nextFocusElem.length==0)  return false;
            $('.curFocus').removeClass('curFocus');
            nextFocusElem.addClass('curFocus');
            //如果是layui-unselect
            if (nextFocusElem.hasClass('layui-unselect')) {
                nextFocusElem.find('.layui-edge').click();
            }else {
                //一般的input
                nextFocusElem.focus();
            }
            return true;
        }

        //回车焦点移至同列下一行单元格的输入框，如果到了底部，则焦点移至下一列第一行的单元格输入框
        $(document).keydown(function(event){
            if (event.keyCode == 13){
                var inputFocus = $(event.target);
                var curTd;
                var nextFocusElem ;

                //td的input元素下一个input框
                nextFocusElem = inputFocus.nextAll().not('[readonly]').first();
                if (nextFocusElem.length>0) {
                    nextFocusElem.focus();
                    return true;
                }

                //下一个td的input元素的第一个input框或者select控件
                curTd =  inputFocus.parent(); if (activeNextTd(curTd)) return true;
                curTd =  $('.curFocus').parents('td'); if (activeNextTd(curTd)) return true;
                addTr();//
            }
        });

        //药品信息map key=药品序号 value=药品信息
        function convertRecipeItemMap(recipeGroupItemArr,isRecipeItem) {
            var recipeGroupItemMap = {};
            $(recipeGroupItemArr).each(function (i,recipeGroupItem) {
                if (isRecipeItem) {
                    recipeGroupItemMap[recipeGroupItem.medicineId] = recipeGroupItem;
                }else {
                    recipeGroupItemMap[recipeGroupItem.chargeItemId] = recipeGroupItem;
                }

            });
            return recipeGroupItemMap;
        }

        //选择处方的药品详细信息
        function selectRecipeMedicineInfo(medicineIds) {
            var recipeMedicineInfoArray = [];
            $.ajax({
                type: "POST",
                url: '../outpatient/selectRecipeMedicineInfo.jo',
                data: {medicineIds:medicineIds},
                dataType:"json",
                async:false,//同步 请求
                success: function(data){ recipeMedicineInfoArray = data;},
                error: function(res){jqueryPostError(res);}
            });//ajax end
            return recipeMedicineInfoArray;
        }
    });//layui.use end
</script>
