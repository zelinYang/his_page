/*!
 * control.edit
 * version: 1.0.0 */!function(a,b){Date.prototype.Format=function(a){var b={"M+":this.getMonth()+1,"d+":this.getDate(),"H+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(a)&&(a=a.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var c in b)new RegExp("("+c+")").test(a)&&(a=a.replace(RegExp.$1,1==RegExp.$1.length?b[c]:("00"+b[c]).substr((""+b[c]).length)));return a}}(window),function(a,b){function c(a){var b=a.newValue,c=this.parentNode.getAttribute("tl-model"),d=JSON.parse(c);null!=d&&(d.VALUE=b,this.parentNode.setAttribute("tl-model",JSON.stringify(d)))}function d(b,d){var e=b.innerHTML.replace(/\u200B/g,"");if(""!==e&&null!=e&&"BODY"!==b.tagName&&"HTML"!==b.tagName){var f=b.parentNode.getAttribute("emr-model");if(null!=decodeURIComponent(f)&&""!==decodeURIComponent(f)){var g=JSON.parse(decodeURIComponent(f));"1"===g.mode&&e===g.desc&&(b.innerText=""),b.removeEventListener("DOMCharacterDataModified",c,!1),b.addEventListener("DOMCharacterDataModified",c,!1),d=d||a.event,d.stopPropagation?d.stopPropagation():d.cancelBubble=!0}}}function e(a){var b=a.innerHTML.replace(/\u200B/g,""),c=a.parentNode.getAttribute("emr-model");if(null!=decodeURIComponent(c)&&""!==decodeURIComponent(c)){var d=JSON.parse(decodeURIComponent(c));""===b&&(a.innerText=d.desc)}}a.listenHooks===b&&(a.listenHooks={}),a.listenHooks.text={listenDom:function(a,b,c){"readonly"!==c&&"print"!==c&&($(a).click(function(b){for(var c=b.target;!c.className||c.className.indexOf("emr-ctrl")===-1;)c=c.parentElement;var e=c.getAttribute("emr-model")?JSON.parse(decodeURIComponent(c.getAttribute("emr-model"))):{};"0"!==e.mode&&(e.functionName?parent[e.functionName]?parent[e.functionName](c,e.fieldName):"":d(a,b))}),$(a).blur(function(b){e(a)}))}}}(window),function(window,undefined){function isNumber(a){var b=/^\d+(\.\d+)?$/,c=/^(-(([0-9]+\.[0-9]*[1-9][0-9]*)|([0-9]*[1-9][0-9]*\.[0-9]+)|([0-9]*[1-9][0-9]*)))$/;return b.test(a)||c.test(a)}window.listenHooks===undefined&&(window.listenHooks={});var ctrlModelHooks={1:function(element,event){var oldValue,newValue,totalValue,$oldValueDom,$totalValueDom,dataLength=isNumber($(element.parentElement).attr("data-length"))?parseInt($(element.parentElement).attr("data-length"))-1:0,detailLength=isNumber($(element.parentElement).attr("detail-length"))?parseInt($(element.parentElement).attr("detail-length")):0,target=event.target,id=element.parentElement.id;if("TD"===target.nodeName&&target.classList.contains("td-click")){var opt=element.parentElement.getAttribute("emr-model")?JSON.parse(decodeURIComponent(element.parentElement.getAttribute("emr-model"))):{},trIndex=isNumber($(target).attr("tr-index"))?parseInt($(target).attr("tr-index")):0,tdIndex=isNumber($(target).attr("td-index"))?parseInt($(target).attr("td-index")):0;if("1"===opt.ctrlType){for(var j=0;j<detailLength;j++)for(var k=0;k<dataLength;k++)if(k===tdIndex)if(j===trIndex){$(target).addClass("td-selected"),$oldValueDom=$("#"+id+detailLength+k),$totalValueDom=$("#"+id+detailLength+dataLength),oldValue=isNumber($oldValueDom.html())?parseInt($oldValueDom.html()):0,newValue=isNumber($(target).attr("dic-score"))?parseInt($(target).attr("dic-score")):0,totalValue=isNumber($totalValueDom.html())?parseInt($totalValueDom.html()):0;var count=totalValue+newValue-oldValue;$oldValueDom.html(newValue),$totalValueDom.html(count),$("#"+id+"bz").find("li").each(function(){var standard=$(this).find("span").eq(0).attr("standard");standard&&eval(standard.replace(/x/g,count))?$(this).addClass("selected"):$(this).removeClass("selected")})}else $("#"+id+j+k).removeClass("td-selected")}else for(var j=0;j<dataLength;j++)for(var k=0;k<detailLength;k++)j===trIndex&&(k===tdIndex?($(target).addClass("td-selected"),$oldValueDom=$("#"+id+j+detailLength),$totalValueDom=$("#"+id+dataLength+detailLength),oldValue=isNumber($oldValueDom.html())?parseInt($oldValueDom.html()):0,newValue=isNumber($(target).attr("dic-score"))?parseInt($(target).attr("dic-score")):0,totalValue=isNumber($totalValueDom.html())?parseInt($totalValueDom.html()):0,$oldValueDom.html(newValue),$totalValueDom.html(totalValue+newValue-oldValue)):$("#"+id+j+k).removeClass("td-selected"))}},2:function(a,b){this[1](a,b)},3:function(element,event){id=element.parentElement.id;var target=event.target;if("TD"===target.nodeName&&target.classList.contains("td-click")){var radioFlag=target.getAttribute("radio-flag"),dicTypeId=target.getAttribute("dic-type-id"),totalScoreDom=$(target).parent().parent().find("#total-score"),trScoreDom=$(target).parent().parent().find("#"+dicTypeId),totalScore=isNumber($(totalScoreDom).html())?parseInt($(totalScoreDom).html()):0,trScore=isNumber($(trScoreDom).html())?parseInt($(trScoreDom).html()):0,tdScore=isNumber(target.getAttribute("dic-score"))?parseInt(target.getAttribute("dic-score")):0;if("1"===radioFlag){if(target.classList.contains("td-selected"))return;$(target).parent().parent().find('td[dic-type-id="'+dicTypeId+'"]').each(function(){this.isEqualNode(target)?$(this).addClass("td-selected"):$(this).removeClass("td-selected")}),totalScore=totalScore-trScore+tdScore,trScoreDom.html(tdScore),totalScoreDom.html(totalScore)}else target.classList.contains("td-selected")?($(target).removeClass("td-selected"),trScore-=tdScore,totalScore-=tdScore):($(target).addClass("td-selected"),trScore+=tdScore,totalScore+=tdScore),trScoreDom.html(trScore),totalScoreDom.html(totalScore);$("#"+id+"bz").find("li").each(function(){var standard=$(this).find("span").eq(0).attr("standard");standard&&eval(standard.replace(/x/g,totalScore))?$(this).addClass("selected"):$(this).removeClass("selected")})}},4:function(a,b){id=a.parentElement.id;var c=b.target;if("TD"===c.nodeName&&c.classList.contains("td-click")){$(c).addClass("td-selected");for(var d=$(c);d.prev().attr("medicine-dic-code");)d.prev().removeClass("td-selected"),d=d.prev();for(d=$(c);d.next().attr("medicine-dic-code");)d.next().removeClass("td-selected"),d=d.next()}}};window.listenHooks.clicktable={listenDom:function(a,b){$(a).unbind(),$(a).click(function(a){ctrlModelHooks[b.ctrlModel](this,a)})}}}(window),function(a,b){a.listenHooks===b&&(a.listenHooks={}),a.listenHooks.date={listenDom:function(a,b,c){"0"!==b.mode&&"readonly"!==c&&"print"!==c&&layui.use(["laydate"],function(){var d,e=layui.laydate;"design"===c||b.defvalue||(1===b.rangeFlag?b.defvalue=(new Date).Format(b.format)+" - "+(new Date).Format(b.format):b.defvalue=new Date,a.parentElement.setAttribute("emr-model",decodeURIComponent(JSON.stringify(b))));var f=a;$(a).find("input").length>0&&(f=$(a).find("input")[0]),d=b.format.indexOf("y")>-1||b.format.indexOf("M")>-1||b.format.indexOf("d")>-1?b.format.indexOf("H")>-1||b.format.indexOf("m")>-1||b.format.indexOf("s")>-1?"datetime":"date":"time",1===b.rangeFlag?e.render({elem:f,format:b.format,type:d,value:b.defvalue,range:!0,done:function(d,e,f){"design"!==c&&(b.defvalue=d,a.parentElement.setAttribute("emr-model",decodeURIComponent(JSON.stringify(b))))}}):e.render({elem:f,format:b.format,type:d,value:b.defvalue?new Date(b.defvalue).Format(b.format):(new Date).Format(b.format),done:function(d,e,f){"design"!==c&&(b.defvalue=d,a.parentElement.setAttribute("emr-model",decodeURIComponent(JSON.stringify(b))))}})}),$(a).click(function(a){a.stopPropagation?a.stopPropagation():a.cancelBubble=!0})}}}(window),function(a,b){a.listenHooks===b&&(a.listenHooks={}),a.listenHooks.radio={listenDom:function(a,b,c){"0"===b.mode||"readonly"===c||"print"===c?$(a).find("input").attr("disabled","disabled"):$(a).click(function(a){for(var b=a.target;"INPUT"!==b.nodeName;)b=b.firstChild;b.setAttribute("checked","checked");for(var c=b.parentNode.previousSibling;c;)c.firstChild.removeAttribute("checked"),c=c.previousSibling;for(var d=b.parentNode.nextSibling;d;)d.firstChild.removeAttribute("checked"),d=d.nextSibling})}}}(window),function(a,b){a.listenHooks===b&&(a.listenHooks={}),a.listenHooks.checkbox={listenDom:function(a,b){"0"===b.mode?$(a).find("input").attr("disabled","disabled"):$(a).click(function(a){for(var b=a.target;"INPUT"!==b.nodeName;)b=b.firstChild;b.checked?b.setAttribute("checked","checked"):b.removeAttribute("checked")})}}}(window),function(a,b){function c(a){var b=a.offsetTop;return null!=a.offsetParent&&(b+=c(a.offsetParent)),b}function d(a){var b=a.offsetLeft;return null!=a.offsetParent&&(b+=d(a.offsetParent)),b}function e(a){var b=document.getElementsByClassName("tl-ui-select");null!=b&&b.length>0&&(b[0].remove(),document.body.onclick=null),document.body.onclick=function(b){if(!(1===a&&$(b.target.outerHTML).attr("class")&&$(b.target.outerHTML).attr("class").indexOf("tl-ui-select-selecteitem")>-1)){var c=document.getElementsByClassName("tl-ui-select");if(0!==c.length){var d,e=c[0].parentNode.parentNode,f=JSON.parse(decodeURIComponent($(e).attr("emr-model"))),g=[];if(1===a){if(null!=c&&c.length>0){for(var h=0,i=c.length;h<i;h++){var j=[];$(c[0]).find("ul:first-child").find("li").each(function(){$(this).attr("class").indexOf("selected")>-1&&(j.push($(this).html()),g.push({label:this.getAttribute("tl-text"),value:this.getAttribute("tl-value")}))}),j.length>0?(d=j.join(","),e.setAttribute("emr-value",encodeURIComponent(JSON.stringify(g)))):(d=1===f.inputFlag?"":"请选择",e.setAttribute("emr-value",encodeURIComponent(JSON.stringify([])))),1===f.inputFlag?$(c[0]).parent().find("input").val(d):$(c[0]).parent().html(d)}c[0].remove(),document.body.onclick=null}}else null!=c&&c.length>0&&(b.target.getAttribute("class")&&b.target.getAttribute("class").indexOf("tl-ui-select-selecteitem")>-1&&(g.push({label:b.target.getAttribute("tl-text"),value:b.target.getAttribute("tl-value")}),1===f.inputFlag?$(c[0]).parent().find("input").val(b.target.innerHTML):$(c[0]).parent().html(b.target.innerHTML),e.setAttribute("emr-value",encodeURIComponent(JSON.stringify(g)))),c[0]&&c[0].remove(),document.body.onclick=null)}}}}function f(a,b,e){if(!(null==b||b.length<=0)){var f=(a.offsetWidth,24),g=d(a),h=c(a)+a.offsetHeight,i=[];i.push('<ul class="tl-ui-select-content" style="max-height: 200px; overflow: auto;">');for(var j=0,k=b.length;j<k;j++)i.push('<li contenteditable="false" '),i.push(' tl-value="'+b[j].value+'" '),i.push(' tl-text="'+b[j].label+'" '),i.push(' title="'+b[j].label+'" '),i.push(' style="height: '+f+"px; line-height: "+f+'px;" font-size="24px" '),(","+e+",").indexOf(","+b[j].label+",")>-1?i.push(' class="tl-ui-select-selecteitem selected" '):i.push(' class="tl-ui-select-selecteitem" '),i.push(">"),i.push(b[j].label),i.push("</li>");i.push("</ul>");var l=document.createElement("div");l.setAttribute("class","tl-ui-select"),l.style.left=g+"px",l.style.top=h+"px",l.style.overflow="hidden",l.style.display="block",l.innerHTML=i.join(""),setTimeout(function(){a.insertBefore(l,a.childNodes[a.childNodes.length-1]),$(".tl-ui-select-selecteitem").click(function(){$(this).toggleClass("selected")})},100)}}function g(a,b,c){return null==b?"":void(null!=b.remotedata&&""!==b.remotedata.url?axios(b.remotedata).then(function(b){b.data&&b.data.data.length>0&&f(a,b.data.data,c)})["catch"](function(a){console.error(a)}):f(a,JSON.parse(b.bindingdata),c))}a.listenHooks===b&&(a.listenHooks={}),a.listenHooks.select={listenDom:function(a,b,c){$(a).unbind(),"readonly"!==c&&"print"!==c&&$(a).on("click",function(a){if(!($(this).find(".tl-ui-select").length>0)){var b=a.target;if("BODY"!==b.tagName&&"HTML"!==b.tagName){for(;!b.className||b.className.indexOf("emr-ctrl")===-1;)b=b.parentElement;var c=b.getAttribute("emr-model");if(null!=c&&""!==c){var d=JSON.parse(decodeURIComponent(c));if("0"!==d.mode){var f=1===d.inputFlag?$(b.firstChild).find("input").val():b.firstChild.innerHTML;g(this,d,f),setTimeout(e(d.multi),100)}}}}})}}}(window),function(a,b){a.listenHooks===b&&(a.listenHooks={}),a.listenHooks.clickarea={listenDom:function(a,b){$(a).unbind(),$(a).dblclick(function(a){for(var c=a.target;!c.className||c.className.indexOf("emr-ctrl")===-1;)c=c.parentElement;b.functionName?parent[b.functionName](c):b.clickFlag&&parent.insertTemplate()})}}}(window),function(a,b){a.listenHooks===b&&(a.listenHooks={}),a.listenHooks.list={listenDom:function(a,b){$(a).unbind(),$(a).click(function(a){for(var c=a.target;!c.className||c.className.indexOf("emr-ctrl")===-1;)c=c.parentElement;parent[b.functionName]?parent[b.functionName](c):""})}}}(window),function(a,b){a.listenHooks===b&&(a.listenHooks={}),a.listenHooks.diary={listenDom:function(a,b){"0"!==b.mode&&layui.use(["laydate"],function(){var c=layui.laydate,d=b.fieldName,e=d?d.split(","):[];b.defvalue=b.defvalue?b.defvalue:new Date,e[1]&&$(a).find("td."+e[1]).each(function(){c.render({elem:this,format:"yyyy-MM-dd HH:mm",type:"datetime",value:new Date(b.defvalue).Format("yyyy-MM-dd HH:mm"),done:function(c,d,e){b.defvalue=c,a.parentElement.setAttribute("emr-model",decodeURIComponent(JSON.stringify(b)))}})})}),$(a).unbind(),$(a).click(function(a){for(var b=a.target;!b.className||b.className.indexOf("emr-ctrl")===-1;)b=b.parentElement})}}}(window),function(a,b){function c(a,b,c,d){$.post("../emr/getFormulaImage.action",{formulaId:b,values:c},function(b){"0"===b.code&&($(a.firstChild.firstChild).attr("src",b.data.image),$(a).attr("formula-value",encodeURIComponent(b.data.value)),parent.layer.close(d))},"json")}a.listenHooks===b&&(a.listenHooks={});var d={1:"tygs.html",2:"yjs1.html",3:"yjs2.html",4:"yjs3.html",5:"tk.html",6:"gdw.html",7:"tx.html",8:"bc.html",9:"hy.html"};a.listenHooks.medicalformula={listenDom:function(a,b){$(a).unbind(),$(a).dblclick(function(a){a.stopPropagation?a.stopPropagation():a.cancelBubble=!0;for(var b=a.target;!b.className||b.className.indexOf("emr-ctrl")===-1;)b=b.parentElement;var e=b.getAttribute("emr-model")?JSON.parse(decodeURIComponent(b.getAttribute("emr-model"))):{},f=b.getAttribute("formula-value");parent.layui.layer.open({type:2,title:"医学公式",content:["../resource/editor/mini-editor/dialogs/medicalformula/"+d[e.formulaType]+"?formulaValue="+f,"no"],area:["500px","500px"],btn:["确定","取消"],scrollbar:!1,yes:function(a,d){var f,g=parent["layui-layer-iframe"+a],h="LAY-emr-submit",i=d.find("iframe").contents().find("#"+h);"9"===e.formulaType?(f=d.find("iframe")[0].contentWindow.getValues(),c(b,e.formulaType,JSON.stringify(f),a)):(g.layui.form.on("submit("+h+")",function(d){var g=d.field,h=Object.getOwnPropertyNames(g).length;f=[];for(var i=1;i<=h;i++)f.push(g["content"+i]);c(b,e.formulaType,f.join(","),a)}),i.trigger("click"))},cancel:function(a,b){parent.layer.close(a)},success:function(a,b){}})})}}}(window),function(a,b){a.listenHooks===b&&(a.listenHooks={}),a.listenHooks.edittable={listenDom:function(a,b){if($(a).children().each(function(c){b.rowsNum>c||($(this).click(function(){$(a).children().removeClass("tr-selected"),$(this).addClass("tr-selected")}),$(this).find("input").each(function(){$(this).click(function(){for(var b=this;"TR"!==b.nodeName;)b=b.parentNode;$(a).children().removeClass("tr-selected"),$(b).addClass("tr-selected")})}))}),b.countField)for(var c=b.countField.split(","),d=0,e=c.length;d<e;d++)$(a).find("#"+c[d]).find("input").unbind(),$(a).find("#"+c[d]).find("input").bind("input propertychange",function(){console.log($(this).val())})}}}(window),function(a,b){a.refreshListener=function(b,c){console.log("初始化"),$(document).on("paste",function(){});for(var d=document.getElementsByClassName("emr-value"),e=0;e<d.length;e++){var f=d[e].parentElement.getAttribute("emr-type"),g=d[e].parentElement.getAttribute("emr-model")?JSON.parse(decodeURIComponent(d[e].parentElement.getAttribute("emr-model"))):{},h=(d[e].parentElement.id,a.listenHooks[f]);if(h&&h.listenDom){if(c){var i=!1;for(var j in c)if(c[j]!==g[j]){i=!0;break}if(i)continue}h.listenDom(d[e],g,b)}}},a.traceListener=function(){$("ins").mouseover(function(a){var b=a.target.getAttribute("msg");"DEL"===a.target.nodeName&&(b=a.target.parentNode.getAttribute("msg")+"<br><div>"+b+"</div>"),layer.tips(b,a.target,{tips:3,area:["250px","auto"],time:1e4})})}}(window);