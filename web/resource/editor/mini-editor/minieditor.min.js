/*!
 * minieditor
 * version: 1.0.0 */!function(b,c){function d(a,d,e,f,g,h){return new c.ui.Dialog({iframeUrl:b.UEDITOR_CONFIG.UEDITOR_HOME_URL+c.EMRDesignTemplateUrl+e,name:d,editor:a,title:f,cssRules:g,buttons:h})}function e(a){c.plugins[a.name]=function(){function b(){c.addListener("mouseover",function(b,c){if("readonly"!==window.miniEditor.modelType){for(var d=c.target;!d.className||d.className.indexOf("emr-ctrl")===-1;){if("BODY"===d.tagName||"HTML"===d.tagName)return;d=d.parentElement}var e=d.getAttribute("emr-model");if(e){var f=JSON.parse(decodeURIComponent(e)),h="",i="";switch(window.miniEditor.modelType){case"design":var j="";switch(f.mode){case"0":j="只读模式";break;case"1":j="编辑模式";break;case"2":j="隐藏模式"}h=g.formatHtml("<nobr>"+f.desc+" "+a.label+"("+j+'): <span onclick=$$._edit() class="edui-clickable">编辑</span>&nbsp;&nbsp;<span onclick=$$._delete() class="edui-clickable">删除</span></nobr>');break;case"edit":case"strict":var k=d.getAttribute("emr-type");if("edittable"!==k)return;i='<span onclick=$$._add() class="edui-clickable">新增一行</span>&nbsp;&nbsp;<span onclick=$$._deleteTr() class="edui-clickable">删除</span></nobr>',1===f.volumeFlag&&(i='<span onclick=$$._count() class="edui-clickable">小结</span>&nbsp;&nbsp;<span onclick=$$._addVolume() class="edui-clickable">新增出入量</span>&nbsp;&nbsp;'+i),h=g.formatHtml("<nobr>操作:"+i)}f.type===a.type?(g.getDom("content").innerHTML=h,g.anchorEl=d,g.opt=f,g.showAnchor(g.anchorEl)):g.hide()}}})}var c=this,e=a.name,f=d(c,e,a.url+"?temp="+(new Date).getTime(),name.label,"width:800px;height:400px;",[{className:"edui-okbutton",label:"确定",onclick:function(){f.close(!0)}},{className:"edui-cancelbutton",label:"取消",onclick:function(){f.close(!1)}}]);c.commands[e]={execCommand:function(){f.render(),f.open()}};var g=new baidu.editor.ui.Popup({editor:this,content:"",className:"edui-bubble",_edit:function(){for(var a=g.anchorEl;null==a.getAttribute("emr-model");)a=a.parentNode;baidu.editor.plugins[e].editdom=new MiniControl(a),c.execCommand(e),this.hide()},_delete:function(){if(window.confirm("是否删除？")){for(var a=this.anchorEl;null==a.getAttribute("emr-model");)a=a.parentNode;baidu.editor.dom.domUtils.remove(a,!1)}this.hide()},_add:function(){var a,b=this.anchorEl,c=$(b).children(":first"),d=this.opt;c.children().each(function(b){return b<d.rowsNum||(this.id?void 0:(a=$(this).clone(),!1))}),a&&(a.find("td").each(function(){var a=$(this).find(".emr-ctrl");$(this).attr("rowspan",1);for(var b=0,c=a.length;b<c;b++){var d=new MiniControl(a[b]),e=d.getOpt();"date"===d.getTypeName()?d.setValue(new Date):"text"===d.getTypeName()&&0===d.getOpt().inputFlag?"exeUserName"===d.getCtrlId()||"createUserName"===d.getCtrlId()?d.setValue(window.minieditorDesign.initData.SysUser.name):d.setValue(d.getOpt().desc):d.setValue(""),e.mode="1",d.setOpt(e),$(d.getValueElement()).attr("contenteditable","true"),$(d.getValueElement()).find('input[type="text"]').removeAttr("readonly")}}),$(a).removeAttr("data"),c.append(a),$("#ueditor_0")[0].contentWindow.refreshListener&&$("#ueditor_0")[0].contentWindow.refreshListener())},_addVolume:function(){var a=this.opt,b=a.fieldName.split(",").length,c=window.miniEditor.editor.selection.getRange();c.select();for(var d=c.startContainer;"TR"!==d.tagName;)d=d.parentNode;for(var e=d;$(e).children().length!==b;)e=e.previousSibling;var f=d;f.nextSibling&&$(f.nextSibling).children().length!==b&&(f=f.nextSibling);var g=$(e).clone();g.removeAttr("data"),g.children().each(function(a){var b=$(this).find(".emr-ctrl").attr("id");if(b.indexOf("InpatientInVolume")>-1||b.indexOf("InpatientOutVolume")>-1){var c=new MiniControl($(this).find(".emr-ctrl")[0]);c.setValue("")}else $(this).remove()}),$(f).after(g),$(e).children().each(function(a){var b=$(this).attr("rowspan")?$(this).attr("rowspan"):1,c=$(this).find(".emr-ctrl").attr("id");c.indexOf("InpatientInVolume")===-1&&c.indexOf("InpatientOutVolume")===-1&&$(this).attr("rowspan",parseInt(b)+1)}),$("#ueditor_0")[0].contentWindow.refreshListener&&$("#ueditor_0")[0].contentWindow.refreshListener()},_deleteTr:function(){var a=window.miniEditor.editor.selection.getRange();a.select();for(var b=a.startContainer;"TR"!==b.tagName;)b=b.parentNode;if($(b).attr("data"))return void layer.msg("不能删除已保存数据",{icon:2});var c=this.anchorEl,d=this.opt,e=d.fieldName.split(",").length;if($(b).children().length!==e){for(var f=b;$(f).children().length!==e;)f=f.previousSibling;$(f).children().each(function(a){var b=$(this).attr("rowspan")?$(this).attr("rowspan"):1;$(this).find(".emr-ctrl").attr("id").indexOf("_")===-1&&$(this).attr("rowspan",parseInt(b)-1)})}else{var g=$(c).children(":first").find("tr").length;if(g-1===parseInt(d.rowsNum))return void layer.msg("不能删除所有的数据",{icon:2});for(var h=b.nextSibling;h&&$(h).children().length!==e;)h=h.nextSibling,$(h.previousSibling).remove()}$(b).remove()},_count:function(){for(var a,b,c=this.anchorEl,d=$(c).children("tbody:first"),e=this.opt,f={},g=e.countField.split(","),h=e.fieldName.split(","),i={},j=0,k=g.length;j<k;j++)i[g[j]]=-1;var l=e.fieldName.split(",").length,m=window.miniEditor.editor.selection.getRange();m.select();for(var n=m.startContainer;"TR"!==n.tagName;)n=n.parentNode;for(var o=n;$(o).children().length!==l;)o=o.previousSibling;if(o.firstChild){var p=new MiniControl($(o).find(".emr-ctrl")[0]);b=p.getValue()}for(var q=n;q.nextSibling&&$(q.nextSibling).children().length!==l;)q=q.nextSibling;var r=e.rowsNum,s=d.find(".summary");if(s.each(function(){r=$(this).index()+1}),$(n).index()<r)return void layer.msg("前面数据已统计，不能进行统计",{icon:2});$(c).children("tbody:first").find("tr").each(function(b){if(r&&b<parseInt(r))return!0;if(r&&b===parseInt(r)&&this.firstChild){var c=new MiniControl($(this.firstChild).find(".emr-ctrl")[0]);a=c.getValue()}return $(this).children().each(function(a,b){var c=$(this).find(".emr-ctrl");if(0===c.length)return!1;var d=new MiniControl(c[0]),e=d.getValue(),h=c.attr("id");g.contains(h)&&(i[h]===-1&&(i[h]=a),e=e?e:0,f[i[h]]=(f[i[h]]?f[i[h]]:0)+parseInt(e))}),!this.isSameNode(q)&&void 0});var t=[];t.push('<tr class="summary">'),t.push("<td>"+MiniControl.getIntervalHour(a,b)+"小时出入量统计</td>");for(var j=1,k=h.length;j<k;j++)t.push("<td>"+(f[j]?f[j]:"")+"</td>");t.push("</tr>"),$(q).after($(t.join("")))}});g.render(),b(),baidu.editor.plugins[e].domListener=b}}c.EMRDesignTemplateUrl="mini-editor/dialogs/",Date.prototype.Format=function(a){var b={"M+":this.getMonth()+1,"d+":this.getDate(),"H+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(a)&&(a=a.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var c in b)new RegExp("("+c+")").test(a)&&(a=a.replace(RegExp.$1,1==RegExp.$1.length?b[c]:("00"+b[c]).substr((""+b[c]).length)));return a},c.plugins.insertcontrol=function(){var b=this,d="insertcontrol";b.commands[d]={execCommand:function(d,e,f){var g,h="",i=["lable"],j=e.getAttribute("emr-type"),k=e.querySelector("emr-value");switch(f.type){case"select":case"radio":case"checkbox":if(f.remotedata)axios(f.remotedata).then(function(a){if("radio"===f.type)e.firstChild.innerHTML=MiniControl.generateRadioHtml(a.data.data);else if("checkbox"===f.type)e.firstChild.innerHTML=MiniControl.generateCheckboxHtml(a.data.data,f.arrayFlag);else if("select"===f.type&&1===f.inputFlag){for(var c=42,d=0,h=a.data.data.length;d<h;d++)c<14*a.data.data[d].label.length&&(c=14*a.data.data[d].label.length);$(e.firstChild).find("input").width(c)}e.setAttribute("bindingdata",encodeURIComponent(JSON.stringify(a.data.data))),g=void b.execCommand("insertHtml",e.outerHTML+"&nbsp;"),document.getElementById("ueditor_0").contentWindow.refreshListener()})["catch"](function(a){console.error(a),g=void b.execCommand("insertHtml",e.outerHTML+"&nbsp;"),document.getElementById("ueditor_0").contentWindow.refreshListener()});else{if(f.bindingdata)if("radio"===f.type)e.firstChild.innerHTML=MiniControl.generateRadioHtml(JSON.parse(f.bindingdata));else if("checkbox"===f.type)e.firstChild.innerHTML=MiniControl.generateCheckboxHtml(JSON.parse(f.bindingdata),f.arrayFlag);else if("select"===f.type&&1===f.inputFlag){for(var l=42,m=0,n=f.bindingdata.length;m<n;m++)l<14*f.bindingdata[m].label.length&&(l=14*f.bindingdata[m].label.length);$(e.firstChild).find("input").width(l)}g=void b.execCommand("insertHtml",e.outerHTML+"&nbsp;"),document.getElementById("ueditor_0").contentWindow.refreshListener()}break;case"clicktable":var o,p,q,r,s=f.rowName.split(","),t=f.columnName.split(","),u=f.fieldName.split(","),v=s.length,w=t.length+1,x=[];f.remotedata&&axios(f.remotedata).then(function(a){var d=a.data.data;switch(f.ctrlModel){case"3":for(o=c.dom.domUtils.createElement(document,"tr",{"class":"firstRow",contenteditable:!1}),k=0;k<v;k++)r=c.dom.domUtils.createElement(document,"td",{contenteditable:!1}),0===k&&r.setAttribute("colspan","2"),r.innerHTML=s[k],o.appendChild(r);e.firstChild.appendChild(o),$.each(d,function(a,b){if(a!==d.length-1){var g=t[a],h=g.indexOf("（多选）")>-1?"0":"1";$.each(b,function(d,i){q=c.dom.domUtils.createElement(document,"tr",{contenteditable:!1}),0===d&&(r=c.dom.domUtils.createElement(document,"td",{rowspan:b.length,contenteditable:!1}),r.innerHTML=g,q.appendChild(r)),r=c.dom.domUtils.createElement(document,"td",{contenteditable:!1,"dic-id":i.dicId,"dic-name":i.dicName,"dic-code":i.dicCode,"dic-type-id":i.dicTypeId,"dic-type-name":i.dicTypeName,id:e.id+a+d,"class":"td-click","dic-score":i.dicScore?i.dicScore:0,"radio-flag":h}),"1"===f.ctrlType&&$(r).attr("field-name",u[a]),r.innerHTML=i.dicName+"("+(i.dicScore?i.dicScore:0)+"分)",q.appendChild(r),0===d&&(r=c.dom.domUtils.createElement(document,"td",{contenteditable:!1,id:i.dicTypeId,rowspan:b.length}),q.appendChild(r)),e.firstChild.appendChild(q)})}});var h=c.dom.domUtils.createElement(document,"tr",{contenteditable:!1});for(k=0;k<v;k++)r=c.dom.domUtils.createElement(document,"td",{contenteditable:!1}),0===k?(r.setAttribute("colspan","2"),x.push('<ul id="'+e.id+'bz" style="padding-left: 0px;">'),$.each(d[d.length-1],function(a,b){x.push("<li>"),x.push('<span dic-code="'+b.dicCode+'" standard="'+b.dicNote+'">'+b.dicName+"</span>"),x.push("</li>")}),x.push("</ul>"),$(r).html(x.join("")),r.setAttribute("contenteditable","true")):r.setAttribute("id","total-score"),h.appendChild(r);e.firstChild.appendChild(h);break;case"4":if(2!==d.length)return;var i=d[0],j=d[1];o=c.dom.domUtils.createElement(document,"tr",{"class":"firstRow",contenteditable:!1});for(var k=0;k<parseInt(f.columnNum);k++){r=c.dom.domUtils.createElement(document,"td",{contenteditable:!1}),r.innerHTML="药品/结果",o.appendChild(r);for(var l=0,m=i.length;l<m;l++)r=c.dom.domUtils.createElement(document,"td",{contenteditable:!1}),r.innerHTML=i[l].dicName,o.appendChild(r)}e.firstChild.appendChild(o);var n=j.length;n%2===1&&n++;for(var k=0;k<n;k++){var y=j[k]||{};k%2!==0&&"1"!==f.columnNum||(q=c.dom.domUtils.createElement(document,"tr",{contenteditable:!1}),e.firstChild.appendChild(q)),p=c.dom.domUtils.createElement(document,"td",{contenteditable:!1}),p.innerHTML=y.dicName?y.dicName:"",q.appendChild(p);for(var l=0,m=i.length;l<m;l++)r=c.dom.domUtils.createElement(document,"td",{contenteditable:!1,"class":"td-click","medicine-dic-id":y.dicId,"medicine-dic-type-id":y.dicTypeId,"medicine-dic-code":y.dicCode,"result-dic-id":i[l].dicId,"result-dic-code":i[l].dicCode}),q.appendChild(r)}break;default:if(1===t.length){w=0,t=[];for(var k=0;k<d.length;k++)d[k].length>w&&(w=d[k].length);for(var k=0;k<w;k++)t.push(k+1);w+=2,t.push("分数")}for(var k=0;k<w;k++){q=c.dom.domUtils.createElement(document,"tr",{contenteditable:!1}),0===k&&(q.className="firstRow");for(var l=0;l<v;l++){if(r=c.dom.domUtils.createElement(document,"td",{contenteditable:!1}),0===k)r.innerHTML=s[l];else if(0===l&&(r.innerHTML=t[k-1]),1===k&&l===v-1&&r.setAttribute("rowspan",w-2),k>1&&k<w-1&&l===v-1)continue;q.appendChild(r)}e.firstChild.appendChild(q)}if(d&&d.length>0){var z=d.length,A=d[0].length;e.setAttribute("data-length",z),e.setAttribute("detail-length",A),$(e).find(":first-child").find("tr").each(function(a){var b=a;0!==b&&b<=A?$(this).find("td").each(function(a){var c=a;if(0!==c&&c<z){var g=b-w+1+d[c-1].length;if(g>=0){var h=d[c-1][g];h.dicScore||0===h.dicScore?("1"===f.ctrlModel?$(this).html(h.dicScore+"分"):$(this).html(h.dicName+"("+h.dicScore+"分)"),$(this).attr("dic-id",h.dicId),$(this).attr("dic-name",h.dicName),$(this).attr("dic-code",h.dicCode),$(this).attr("dic-type-id",h.dicTypeId),$(this).attr("dic-type-name",h.dicTypeName),$(this).attr("dic-score",h.dicScore),$(this).attr("id",e.id+(b-1)+(c-1)),$(this).attr("class","td-click"),$(this).attr("tr-index",b-1),$(this).attr("td-index",c-1),"1"===f.ctrlType&&$(this).attr("field-name",u[c-1])):$(this).html("-")}else $(this).html("-")}else c===z&&1===b&&(x.push('<ul id="'+e.id+'bz" style="padding-left: 0px;">'),$.each(d[c-1],function(a,b){x.push("<li>"),x.push('<span dic-code="'+b.dicCode+'" standard="'+b.dicNote+'">'+b.dicName+"</span>"),x.push("</li>")}),x.push("</ul>"),$(this).html(x.join("")),$(this).attr("id",e.id+(b-1)+(c-1)),$(this).attr("tr-index",b-1),$(this).attr("td-index",c-1))}):b===d[0].length+1&&$(this).find("td").each(function(a){var c=a;0!==c&&$(this).attr("id",e.id+(b-1)+(c-1))})})}}g=void b.execCommand("insertHtml",e.outerHTML+"&nbsp;"),document.getElementById("ueditor_0").contentWindow.refreshListener()})["catch"](function(a){console.error(a),g=void b.execCommand("insertHtml",e.outerHTML+"&nbsp;"),document.getElementById("ueditor_0").contentWindow.refreshListener()});break;case"medicalformula":var y="../emr/getFormulaImage.action?formulaId="+f.formulaType;axios(y).then(function(a){"0"===a.data.code&&(e.firstChild.firstChild.setAttribute("src",a.data.data.image),e.setAttribute("formula-value",encodeURIComponent(a.data.data.value))),g=void b.execCommand("insertHtml",e.outerHTML+"&nbsp;"),document.getElementById("ueditor_0").contentWindow.refreshListener()})["catch"](function(a){console.error(a),g=void b.execCommand("insertHtml",e.outerHTML+"&nbsp;"),document.getElementById("ueditor_0").contentWindow.refreshListener()});break;default:return k&&""===k.innerHTML&&""!==f.desc&&(k.innerHTML=a.desc),g=j&&i.indexOf(j)?void b.execCommand("insertHtml",e.outerHTML+"&nbsp;"):void b.execCommand("insertHtml",h+e.outerHTML+h+"&nbsp;"),document.getElementById("ueditor_0").contentWindow.refreshListener("design"),g}}}};for(var f=[{name:"minitext",label:"文本输入框",url:"text/index.html",type:"text"},{name:"minisection",label:"多行文本框",url:"section/index.html",type:"section"},{name:"miniradio",label:"单选框",url:"radio/index.html",type:"radio"},{name:"miniselect",label:"下拉选择框",url:"select/index.html",type:"select"},{name:"minidate",label:"日期选择",url:"date/index.html",type:"date"},{name:"minicheckbox",label:"多选框",url:"checkbox/index.html",type:"checkbox"},{name:"minilabel",label:"标签",url:"label/index.html",type:"label"},{name:"miniclickarea",label:"点击区域",url:"clickarea/index.html",type:"clickarea"},{name:"miniformula",label:"公式",url:"kityformula/index.html",type:"formula"},{name:"minitable",label:"表格",url:"table/index.html",type:"table"},{name:"minilist",label:"列表",url:"list/index.html",type:"list"},{name:"miniclicktable",label:"点击表格",url:"clicktable/index.html",type:"clicktable"},{name:"miniedittable",label:"可编辑表格",url:"edittable/index.html",type:"edittable"},{name:"minimedicalformula",label:"医学公式",url:"medicalformula/index.html",type:"medicalformula"},{name:"minidiary",label:"日程格式",url:"diary/index.html",type:"diary"},{name:"minipicture",label:"图片",url:"picture/index.html",type:"picture"},{name:"minilistblock",label:"列表块",url:"listblock/index.html",type:"listblock"}],g=0;g<f.length;g++)e(f[g]);c.plugins.minitemplate=function(){var a=this,b="minitemplate",c=d(a,b,"template/index.html?temp="+(new Date).getTime(),"控件模板选择","width:800px;height:400px;",[{className:"edui-okbutton",label:"确定",onclick:function(){c.close(!0)}},{className:"edui-cancelbutton",label:"取消",onclick:function(){c.close(!1)}}]);a.commands[b]={execCommand:function(){c.render(),c.open()}};var e=new baidu.editor.ui.Popup({editor:this,content:"",className:"edui-bubble"});e.render()},c.registerUI("tl_select",function(a,b){var e=d(a,b,"select.html?temp="+(new Date).getTime(),"下拉单选输入框","width:600px;height:600px;",[{className:"edui-okbutton",label:"确定",onclick:function(){e.close(!0)}},{className:"edui-cancelbutton",label:"取消",onclick:function(){e.close(!1)}}]),f=new c.ui.Button({name:"下拉单选输入框",title:"下拉单选输入框",cssRules:"background-position: -25px 216px;",onclick:function(){var b=a.selection.getRange(),c=b.startContainer.parentNode;"tl-value"!=c.getAttribute("class")?(e.render(),e.open()):alert("控件内不允许再插入控件！")}});return f}),c.registerUI("combox",function(a,b){a.registerCommand(b,{execCommand:function(a,b){this.execCommand("fontsize",b+"px")},queryCommandValue:function(){return this.queryCommandValue("fontsize")}});for(var d,e=[],f=0;d=[10,11,12,14,16,18,20,24,36][f++];)e.push({label:"字体:"+d+"px",value:d,renderLabelHtml:function(){return'<div class="edui-label %%-label" style="line-height:2;font-size:'+this.value+'px;">'+(this.label||"")+"</div>"}});var g=new c.ui.Combox({editor:a,items:e,onselect:function(c,d){a.execCommand(b,this.items[d].value)},title:b,initValue:b});return a.addListener("selectionchange",function(c,d,e){if(!e){var f=a.queryCommandState(b);if(f==-1)g.setDisabled(!0);else{g.setDisabled(!1);var h=a.queryCommandValue(b);if(!h)return void g.setValue(b);h&&(h=h.replace(/['"]/g,"").split(",")[0]),g.setValue(h)}}}),g},2)}(window,UE),function(){function a(a,b){for(var c="",d=0;d<a.length;d++)if(a[d].dicTypeId==b){c=a[d].patientDicDataId;break}return c}var b=window.MiniControl=function(a){var b=a,c={};if(this.getDom=function(){return b},this.setOpt=function(a){c=a,this.getDom().setAttribute("emr-model",encodeURIComponent(JSON.stringify(c)))},this.getOpt=function(){return c},b){var d=this.getDom().getAttribute("emr-model");c=JSON.parse(decodeURIComponent(d))}};b.uuid=function(a,b){var c,d="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),e=[];if(b=b||d.length,a)for(c=0;c<a;c++)e[c]=d[0|Math.random()*b];else{var f;for(e[8]=e[13]=e[18]=e[23]="-",e[14]="4",c=0;c<36;c++)e[c]||(f=0|16*Math.random(),e[c]=d[19==c?3&f|8:f])}return e.join("")},b.isArrayFn=function(a){return"function"==typeof Array.isArray?Array.isArray(a):"[object Array]"===Object.prototype.toString.call(a)},b.isNumber=function(a){var b=/^\d+(\.\d+)?$/,c=/^(-(([0-9]+\.[0-9]*[1-9][0-9]*)|([0-9]*[1-9][0-9]*\.[0-9]+)|([0-9]*[1-9][0-9]*)))$/;return!(!b.test(a)&&!c.test(a))},b.generateRadioHtml=function(a){var b=[],c=this.uuid(8,16);if(a.length>0)for(var d=0;d<a.length;d++)b.push('<label contenteditable="false"><input name="radio_'+c+'" type="radio"  value="'+a[d].value+'" total-value="'+encodeURIComponent(JSON.stringify(a[d]))+'">'+a[d].label+"</label>");return b.join("")},b.fillSpace=function(a,b){var c=[];if(c.push(a),a&&a.length<b){c.push(a);for(var d=0,e=b-a.length;d<e;d++)c.push("&nbsp;")}return c.join("")},b.generateCheckboxHtml=function(a,c){var d=[],e=this.uuid(8,16);if(a.length>0)if(1===c)for(var f=0;f<a.length;f++)d.push('<label contenteditable="false"><input name="checkbox_'+e+'" type="checkbox"  value="'+a[f].value+' title="'+a[f].value+'" total-value="'+encodeURIComponent(JSON.stringify(a[f]))+'">'+b.fillSpace(a[f].label,10)+"</label>");else for(var f=0;f<a.length;f++)d.push('<label contenteditable="false"><input name="checkbox_'+e+'" type="checkbox"  value="'+a[f].value+'" total-value="'+encodeURIComponent(JSON.stringify(a[f]))+'">'+a[f].label+"</label>");return d.join("")},b.firstUpperCase=function(a){return a.replace(/( |^)[a-z]/g,function(a){return a.toUpperCase()})},b.firstLowerCase=function(a){return a.replace(/( |^)[A-Z]/g,function(a){return a.toLowerCase()})},b.getIntervalHour=function(a,b){var c=b.getTime()-a.getTime();return c<0?0:Math.floor(c/1e3/60/60)},b.prototype={constructor:b,getCtrlId:function(){return this.getDom()?this.getDom().id:""},getCtrlElement:function(){if(this.getDom())return this.getDom()},getValueElement:function(){var a=this.getDom(),b=this.getTypeName();if(a)return"section"===b||"clickarea"===b||"list"===b||"diary"===b?$(a).children("div").eq(0)?$(a).children("div").eq(0)[0]:null:"table"===b||"clicktable"===b||"edittable"===b||"diary"===b?$(a).children("tbody").eq(0)?$(a).children("tbody").eq(0)[0]:null:"picture"===b?$(a).children("img").eq(0)?$(a).children("img")[0]:null:$(a).children("span").eq(0)?$(a).children("span").eq(0)[0]:null},attr:function(a,b){return a?b?void $(this.getDom()).attr(a,b):this.getDom().getAttribute(a):null},getDesc:function(){return this.getOpt().desc?this.getOpt().desc:""},isReadonly:function(){return"0"===this.getOpt().mode},isRequired:function(){return this.getOpt().required&&"1"===this.getOpt().required},setBindingData:function(a){switch(this.getTypeName()){case"radio":this.getValueElement().innerHTML=b.generateRadioHtml(a);break;case"checkbox":this.getValueElement().innerHTML=b.generateCheckboxHtml(a,this.getOpt().arrayFlag)}this.getDom().setAttribute("bindingdata",encodeURIComponent(JSON.stringify(a)))},getBindingData:function(){return this.getDom().getAttribute("bindingdata")?JSON.parse(decodeURIComponent(this.getDom().getAttribute("bindingdata"))):[]},traceCtrlType:["text","radio","select","date","checkbox","clickarea"],getTypeName:function(){return this.getDom().getAttribute("emr-type")},setCtrlDataIds:function(a){var b=this.getOpt(),c=this.getValueElement();switch(this.getTypeName()){case"edittable":var d=0,e=b.fieldName.split(",").length;$(c).children().each(function(c,f){if(b.rowsNum>c)return!0;if($(this).children().length!==e)return!0;var g=$(this).attr("data")?JSON.parse(decodeURIComponent($(this).attr("data"))):{};for(var h in a[d])g[h]=a[d][h];$(this).attr("data",encodeURIComponent(JSON.stringify(g))),d++})}},getValue:function(c){var d,e=this.getCtrlElement(),f=this.getValueElement(),g=this.getOpt(),h="",i=this;switch(i.getTypeName()){case"text":if(g.fieldName){var j=$(e).attr("text-value");j&&(h=JSON.parse(decodeURIComponent(j)))}else 1===g.inputFlag?h=$(f).find("input").val():g&&$.trim(g.desc)!==$.trim(this.getDom().firstChild.innerHTML)&&(h=this.getDom().firstChild.innerHTML);break;case"radio":case"checkbox":var k=[];$(f).find("label").each(function(){var a=$(this).find("input:first-child");a[0]&&a[0].checked&&k.push(JSON.parse(decodeURIComponent(a.attr("total-value"))))}),h=k;break;case"date":g&&$.trim(g.desc)!==$.trim(this.getDom().firstChild.innerHTML)&&(h=1===g.rangeFlag?this.getDom().firstChild.innerHTML:new Date(this.getDom().firstChild.innerHTML.replace(/年|月/g,"-").replace(/时|分/g,":").replace(/日|秒/g," ")));break;case"select":d=this.getDom().getAttribute("emr-value"),h=d?JSON.parse(decodeURIComponent(d)):[];break;case"section":var l=this.getDom().innerHTML;$(this.getDom().firstChild).find(".emr-ctrl").each(function(){var a=new b(this);if("radio"===a.getTypeName()||"checkbox"===a.getTypeName()||"select"===a.getTypeName()){for(var c=new b(this).getValue(),d=[],e=0;e<c.length;e++)d.push(c[e].label);l=l.replace(this.outerHTML,d.join(","))}else l=l.replace(this.outerHTML,new b(this).getValue())}),h=l.replace(/<\/?.+?>/g,"");break;case"clickarea":var l=this.getValueElement().innerHTML;$(this.getDom().firstChild).find(".emr-label").each(function(){l=l.replace(this.outerHTML,"")});var m=!1;$(this.getDom().firstChild).find(".emr-ctrl").each(function(){var a=new b(this);if("medicalformula"===a.getTypeName())return m=!0,g.forlumaFlag=m,void i.setOpt(g);if("radio"===a.getTypeName()||"checkbox"===a.getTypeName()||"select"===a.getTypeName()){for(var c=new b(this).getValue(),d=[],e=0;e<c.length;e++)d.push(c[e].label);l=l.replace(this.outerHTML,d.join(","))}else l=l.replace(this.outerHTML,new b(this).getValue())}),m||(l=l.replace(/<\/?.+?>/g,"")),h=l,h===g.desc&&(h="");break;case"list":h=[],$(this.getDom().firstChild).find("p").each(function(){var a=$(this).attr("data");a&&h.push(JSON.parse(decodeURIComponent(a)))});break;case"clicktable":h={};var n=$(this.getDom()).attr("data")?JSON.parse(decodeURIComponent($(this.getDom()).attr("data"))):[];switch(g.ctrlModel){case"4":var o=[];$(this.getDom()).find(".td-selected").each(function(){var a={dicTypeId:$(this).attr("medicine-dic-type-id"),dicCode:$(this).attr("medicine-dic-code"),value:$(this).attr("result-dic-code")};o.push(a)}),h=o;break;default:var p=b.isNumber($(this.getDom()).attr("data-length"))?parseInt($(this.getDom()).attr("data-length"))-1:0,q=b.isNumber($(this.getDom()).attr("detail-length"))?parseInt($(this.getDom()).attr("detail-length")):0,r=$(this.getDom()).find("#"+this.getDom().id+q+p);r="3"===g.ctrlModel?$(this.getDom()).find("#totalScore"):$(this.getDom()).find("#"+this.getDom().id+q+p);var s=b.isNumber(r.html())?parseInt(r.html()):0;if(h.desc=g.desc,g.levelField){var t=g.levelField?g.levelField.split(","):[];$(this.getDom()).find("li.selected").each(function(){var a=$(this).find("span");1===a.length&&(h[t[0]]=a.attr("dic-code"))}),t.length>1&&(h[t[1]]=s)}"1"===g.ctrlType?$(this.getDom()).find(".td-click.td-selected").each(function(){h[$(this).attr("field-name")]=$(this).attr("dic-code"),h[$(this).attr("field-name")+"Score"]=$(this).attr("dic-score")}):(d=[],n=$(this.getDom()).attr("data")?JSON.parse(decodeURIComponent($(this.getDom()).attr("data"))):[],$(this.getDom()).find(".td-click.td-selected").each(function(){var b={dataElementId:g.dataElementId,dicTypeId:$(this).attr("dic-type-id"),dicTypeName:$(this).attr("dic-type-name"),dicName:$(this).attr("dic-name"),dicCode:$(this).attr("dic-code"),elementName:g.elementName,elementEnName:g.elementEnName,dataValueStr:"",dataValueScore:$(this).attr("dic-score"),patientDicDataId:a(n,$(this).attr("dic-type-id"))};d.push(b)}),h.data=d)}break;case"edittable":h=[];var u,v=g.fieldName.split(","),w=0;$(f).children().each(function(a,c){if(!(g.rowsNum>a)){if(this.id)return!0;if(!this.classList.contains("summary")){var d=$(this).children().length===v.length;d&&(w=0,u=$(this).attr("data")?JSON.parse(decodeURIComponent($(this).attr("data"))):{}),$(this).children().each(function(a,c){var d=$(this).find(".emr-ctrl");d.each(function(){var a=new b(this),c=a.getCtrlId(),d="",e=c.indexOf("_")===-1;switch(a.getTypeName()){case"text":if(a.getOpt().fieldName&&a.getValue()){for(var f=a.getOpt().fieldName.split(","),g=0,h=f.length;g<h;g++)u[f[g]]=a.getValue()[f[g]];return!0}d=a.getValue();break;case"select":case"radio":case"checkbox":for(var i=[],j=0,k=a.getValue().length;j<k;j++)i.push(a.getValue()[j].value);d=i.join(",");break;default:d=a.getValue()}if(e)u[c]=d;else{var l=c.split("_");"InpatientInVolume"===l[0]||"InpatientOutVolume"===l[0]?(u[l[0]]||(u[l[0]]=[]),u[l[0]].length-w===0&&u[l[0]].push({}),u[l[0]][w][l[1]]=d):(u[l[0]]||(u[l[0]]={}),u[l[0]][l[1]]=d)}})}),w++,d&&h.push(u)}}});break;case"medicalformula":h=$(e).attr("formula-value");break;case"diary":h=[],$(f).find("table").each(function(){for(var a={},b=g.fieldName,c=b?b.split(","):[],d=0,e=c.length;d<e;d++)if(c[d]){var f=$(this).find("."+c[d])[0];f&&(a[c[d]]=f.innerHTML.replace(/<\/?.+?>/g,""))}h.push(a)});break;default:g&&$.trim(g.desc)!==$.trim(this.getDom().firstChild.innerHTML)&&(h=this.getDom().firstChild.innerHTML)}return h},setValue:function(a,c,d,e){if(void 0!==a&&null!==a){var f=this.getOpt(),g=(this.getBindingData()?this.getBindingData():[],this.getCtrlElement()),h=this.getValueElement(),i=this,j=[],k=a;switch(a.patientOtherDataId&&($(this.getDom()).attr("patientOtherDataId",a.patientOtherDataId),k="date"===this.getTypeName()?a.tempDate?a.tempDate:"":a.tempValue?a.tempValue:""),c&&g.setAttribute("old-value",encodeURIComponent(k)),this.getTypeName()){case"text":var l="";if(f.fieldName){j=f.fieldName.split(",");var m="";if("object"==typeof k)m=k[j[0]],g.setAttribute("text-value",encodeURIComponent(JSON.stringify(k)));else{var n={};n[j[0]]=k,m=k,g.setAttribute("text-value",encodeURIComponent(JSON.stringify(n)))}c&&g.setAttribute("old-value",encodeURIComponent(m)),l=m}else l=k;1===f.imageFlag&&f.fieldName?"1"===k.signFlag&&(j=f.fieldName.split(","),$.post(contextPath+"/emr/getSignUserInfo.jo",{userId:k[j[1]]},function(a){if("0"===a.code){var b=UE.dom.domUtils.createElement(document,"img",{src:a.data.signPic});h.innerHTML=b.outerHTML}},"json")):1===f.inputFlag?d?l?($(h).find("input").hide(),$(h).html(l)):$(h).find("input").val(this.getOldValue()):($(h).find("input").show(),$(h).find("input").val(l),$(h).find("input").next().remove()):h.innerHTML=l;break;case"radio":$(h).find("label").each(function(){var a=$(this).find("input:first-child");k===a.val()&&(a.attr("checked","checked"),a.click())});break;case"checkbox":var o=k.split(",");$(h).find("label").each(function(){var a=$(this).find("input:first-child");o.contains(a.val())?a[0].checked||a.click():a[0].checked&&a.click()});break;case"date":k&&(f.defvalue=k,k=new Date(k).Format(f.format),h.innerHTML=k,this.setOpt(f));break;case"select":if(Array.isArray(k)){for(var p=[],q=0,r=k.length;q<r;q++)p.push(k[q].value);k=p.join(",")}k=k?""+k:"";var q,s,o=k.split(","),t=[],u=[];f.remotedata&&!f.refreshFlag&&axios(f.remotedata).then(function(a){var b=a.data.data;i.setBindingData(b),f.refreshFlag=!0;for(var c=0;c<o.length;c++)for(var d=0;d<b.length;d++)o[c]==b[d].value&&(t.push(b[d].label),u.push(b[d]));h.innerHTML=t.length>0?t.join(","):"请选择",i.getCtrlElement().setAttribute("emr-value",encodeURIComponent(JSON.stringify(u)))})["catch"](function(a){console.error(a),alert("请求数据失败："+a)});break;case"table":var v=h.firstChild.cloneNode(!0);if(j=f.fieldName.split(","),"InpatientDiagnosis"===g.id){for(var w=[],x=0,y=1,q=0,r=k.length;q<r;q++)"2"===k[q].diseaseTypeFlag?(w[x]=k[q],x+=2):(w[y]=k[q],y+=2);$(h).children().each(function(a){return 0===a||void $(this).children().each(function(b){if(b<3&&!w[2*(a-1)])return!0;if(b>2&&!w[2*a-1])return!0;switch(b){case 0:$(this).html(w[2*(a-1)].diseaseName);break;case 1:$(this).html(w[2*(a-1)].diseaseIcdTcd);break;case 2:$(this).html(w[2*(a-1)].inpatientState);break;case 3:$(this).html(w[2*a-1].diseaseName);break;case 4:$(this).html(w[2*a-1].diseaseIcdTcd);break;case 5:$(this).html(w[2*a-1].inpatientState);break;case 6:$(this).html(w[2*a-1].inpatientState)}})})}else{if(this.deleteTableData(),j=f.fieldName.split(","),k.length>0)for(var q=0;q<k.length;q++){var z=v.cloneNode(!0);0!==q&&z.removeAttribute("class"),$(z).children().each(function(a){this.innerHTML=k[q][j[a]]}),h.appendChild(z)}if(0===k.length&&!f.tableHead){for(var A=UE.dom.domUtils.createElement(document,"tr",{}),s=0;s<j.length;s++){var B=UE.dom.domUtils.createElement(document,"td",{});B.innerHTML="<br />",A.appendChild(B)}h.appendChild(A)}}break;case"clickarea":if($(h).children().each(function(){this.className.indexOf("emr-label")<0&&$(this).remove()}),"InpatientDiagnosis"===this.getCtrlId()&&b.isArrayFn(k)){var C=[],D=[];C.push("<span>中医诊断：</span><br />"),D.push("<span>西医诊断：</span><br />");for(var q=0,r=k.length;q<r;q++){var E=k[q];"1"===E.diseaseTypeFlag&&C.push("<span>&nbsp;&nbsp;&nbsp;&nbsp;"+C.length+"、"+E.diseaseName+"</span><br />"),"2"===E.diseaseTypeFlag&&D.push("<span>&nbsp;&nbsp;&nbsp;&nbsp;"+D.length+"、"+E.diseaseName+"</span><br />")}k="<br />"+C.join("")+D.join("")}var F=UE.dom.domUtils.createElement(document,"p",{});F.innerHTML=k?k:"<br />",h.appendChild(F);break;case"list":if(this.deleteListData(),j=f.fieldName.split(","),b.isArrayFn(k))if(k.length>0)if(f.typeFieldName){var G=f.typeFieldName.split(",");if(G.length>1){for(var H={},I=G[0],J=G[1],q=0;q<k.length;q++)H[k[q][I]]||(H[k[q][I]]=[]),H[k[q][I]].push(k[q]);for(var K in H){var L=UE.dom.domUtils.createElement(document,"p",{contenteditable:"1"===f.mode});L.innerHTML=H[K][0][J],h.appendChild(L);for(var q=0;q<H[K].length;q++){for(var L=UE.dom.domUtils.createElement(document,"p",{contenteditable:"1"===f.mode,data:encodeURIComponent(JSON.stringify(H[K][q]))}),t=[],s=0;s<j.length;s++)t.push(H[K][q][j[s]]);L.innerHTML="&nbsp;&nbsp;"+(q+1)+"."+t.join(","),h.appendChild(L)}}}}else for(var q=0;q<k.length;q++){for(var L=UE.dom.domUtils.createElement(document,"p",{contenteditable:"1"===f.mode,
data:encodeURIComponent(JSON.stringify(k[q]))}),t=[],s=0;s<j.length;s++)t.push(k[q][j[s]]);L.innerHTML=q+1+"."+t.join(","),h.appendChild(L)}else{var L=UE.dom.domUtils.createElement(document,"p",{contenteditable:"1"===f.mode});h.appendChild(L)}else{for(var L=UE.dom.domUtils.createElement(document,"p",{contenteditable:"1"===f.mode}),t=[],q=0;q<j.length;q++)t.push(k[j[q]]);L.innerHTML=t.join(","),h.appendChild(L)}break;case"clicktable":switch($(g).attr("data",encodeURIComponent(JSON.stringify(k))),f.ctrlModel){case"4":b.isArrayFn(k)&&k.length>0&&$.each(k,function(a,b){$(g).find('td[medicine-dic-type-id="'+b.dicTypeId+'"][medicine-dic-code="'+b.dicCode+'"][result-dic-code="'+b.value+'"]').click()});break;default:"1"===f.ctrlType?(j=f.fieldName.split(","),$.each(j,function(a,b){var c=k[b]?k[b].split(","):[];$(g).find('td[field-name="'+b+'"]').each(function(){var a=$(this).attr("radio-flag")?$(this).attr("radio-flag"):"1",b=$(this).attr("dic-code");return"1"===a&&c.contains(b)?void $(this).click():void("1"!==a&&(c.contains(b)&&!this.classList.contains("td-selected")||!c.contains(b)&&this.classList.contains("td-selected"))&&$(this).click())})})):b.isArrayFn(k)&&k.length>0&&$.each(k,function(a,b){$(g).find('td[dic-type-id="'+b.dicTypeId+'"][dic-code="'+b.dicCode+'"]').eq(0).click()})}break;case"edittable":var M=$(h).children().eq(f.rowsNum);if(k&&!Array.isArray(k)){var N=k;k=[],k.push(N)}if(k&&0===k.length&&M.children().each(function(){$(this).find(".emr-ctrl").each(function(){var a=new b(this);"exeUserName"===a.getCtrlId()&&a.setValue(window.minieditorDesign.initData.SysUser.name)})}),Array.isArray(k)){j=f.fieldName.split(",");var O=0,P=0,Q=window.minieditorDesign.initData.SysUser.name;$.each(k,function(a,c){var d="1"===e,f=M.clone();if(f.attr(j[0],c[j[0]]),f.attr("data",encodeURIComponent(JSON.stringify(c))),(c.exeUserName&&c.exeUserName===Q||c.createUserName&&c.createUserName===Q)&&(d=!0),c.headNuserId&&"headNuserName"!==i.getCtrlId()&&(d=!1),f.find("td").each(function(a){var f=$(this).find(".emr-ctrl");f.each(function(){var a=new b(this),f=a.getOpt(),g=a.getCtrlId();if("1"===e&&"headNuserName"===a.getCtrlId()&&(d=!0),"text"===a.getTypeName()&&f.fieldName){for(var h={},i=f.fieldName.split(","),j=0,k=i.length;j<k;j++)h[i[j]]=c[i[j]];h[i[0]]&&a.setValue(h)}else if(g.indexOf("_")>-1){var l=g.split("_"),m=l[0];if(Array.isArray(c[m])&&c[m].length>0){var n=c[m];P=n.length,a.setValue(n[O][l[1]])}else c[m]&&a.setValue(c[m][l[1]])}else a.setValue(c[g]?c[g]:"");d||(f.mode="0",a.setOpt(f),$(a.getValueElement()).attr("contenteditable","false"),$(a.getValueElement()).find('input[type="text"]').attr("readonly","readonly"))})}),O++,M.before(f),P>1){f.children().each(function(){var a=$(this).find(".emr-ctrl").attr("id");a.indexOf("InpatientInVolume")===-1&&a.indexOf("InpatientOutVolume")===-1&&$(this).attr("rowspan",P)});for(var g=O;g<P;g++)f=M.clone(),f.removeAttr("data"),f.children().each(function(){$(this).attr("rowspan",1);var a=$(this).find(".emr-ctrl").attr("id");a.indexOf("InpatientInVolume")===-1&&a.indexOf("InpatientOutVolume")===-1?$(this).remove():$(this).find(".emr-ctrl").each(function(){var a=new b(this),d=a.getCtrlId(),e=d.split("_"),f=e[0];a.setValue(c[f][g][e[1]])})}),M.before(f)}O=0}),k.length>0&&M.remove(),$("#ueditor_0")[0].contentWindow.refreshListener&&$("#ueditor_0")[0].contentWindow.refreshListener()}break;case"medicalformula":$.post("../emr/getFormulaImage.action",{formulaId:f.formulaType,values:k},function(a){"0"===a.code&&($(g.firstChild.firstChild).attr("src",a.data.image),$(g).attr("formula-value",a.data.value))},"json");break;case"diary":if(Array.isArray(k)){var R=$(h).find("table")[0],S=R.outerHTML;$(h).find("table").remove(),$.each(k,function(a,b){var c=$(S),d=f.fieldName,e=d?d.split(","):[];c.attr("data",encodeURIComponent(JSON.stringify(b)));for(var g=0,i=e.length;g<i;g++)if(e[g]&&c.find("."+e[g]).length>0){var j=c.find("."+e[g]);j.attr("contenteditable","false"),1===g?j.html(b[e[g]]?new Date(b[e[g]]).format("yyyy-MM-dd HH:mm"):new Date(b[e[g]]).format("yyyy-MM-dd HH:mm")):j.html(b[e[g]]?b[e[g]]:"")}$(h).append(c)})}$("#ueditor_0")[0].contentWindow.refreshListener&&$("#ueditor_0")[0].contentWindow.refreshListener();break;case"picture":if("1"===f.ctrlType){var T=document.createElement("img");$(T).width("100%").height("100px").JsBarcode(k,{width:3,height:100,displayValue:!1,margin:15}),$(g).html(T)}break;default:h.innerHTML=k}}},refreshData:function(){var a=42,b=this;if(b.getOpt().remotedata)axios(b.getOpt().remotedata).then(function(c){if(b.setBindingData(c.data.data),1===b.getOpt().inputFlag){for(var d=0,e=b.getBindingData().length;d<e;d++)a<14*b.getBindingData()[d].label.length&&(a=14*b.getBindingData()[d].label.length);$(b.getValueElement()).find("input").width(a)}})["catch"](function(a){console.error(a),alert("请求数据失败："+a)});else if(b.setBindingData(JSON.parse(decodeURIComponent(b.getOpt().bindingdata))),1===b.getOpt().inputFlag){for(var c=0,d=b.getBindingData().length;c<d;c++)a<14*b.getBindingData()[c].label.length&&(a=14*b.getBindingData()[c].label.length);$(b.getValueElement()).find("input").width(a)}},deleteTableData:function(){var a=this.getOpt(),b=this.getValueElement();$(b).children().each(function(){this.className.indexOf("firstRow")>-1&&a.tableHead||$(this).remove()})},deleteListData:function(){var a=this.getValueElement();$(a).children().each(function(){this.className.indexOf("emr-label")>-1||$(this).remove()})},refreshListener:function(){$(this.getDom()).find("tr").each(function(){$(this).find("td").each(function(){$(this).click(function(){alert(1)})})})},getOldValue:function(){var a=this.getCtrlElement(),b=a.getAttribute("old-value")?decodeURIComponent(a.getAttribute("old-value")):"";return b},setOldValue:function(a){var b=this.getCtrlElement(),c=this.getOpt();"date"===this.getTypeName()&&(a=a.getTime()),b.setAttribute("old-value",encodeURIComponent(a)),"date"===this.getTypeName()&&(c.defvalue=a,this.setOpt(c))},hasCtrols:function(){return $(this.getDom()).find(".emr-ctrl").length>0},hasParentCtrl:function(){for(var a=this.getDom();"BODY"!=a.nodeName||a.className;);}}}(),function(){var a=window.MiniEditor=function(a){var b=this;b.options=MINIEDITOR_CONFIG,UE.EventBase.call(b);var c=a.modelType?a.modelType:"design";b.modelType=c,UE.utils.clone(a,b.options),b.init(b.options),b.getDefaultModelType=function(){return c}};a.prototype={ready:function(a){var b=this;a&&"function"==typeof a&&(b.isReady?a.apply(b):b.addListener("ready",a))},init:function(a){var b=this;if(null==a.id)return void console.error("参数为空，无法初始化编辑器！");var c=document.getElementById(a.id),d=document.createElement("div");d.className="mini-container",d.style.width=a.outhtmlWidth?a.outhtmlWidth:"794px",c.style.width=a.outhtmlWidth?a.outhtmlWidth:"794px",c.style.margin=a.margin?a.margin:"0px auto 0px",c.style.height=a.height?a.height:"100%";var e=UE.getEditor(a.id,a.editor);e.addListener("keydown",function(a,b){var c=b.keyCode||b.which;if(8===c){var d=e.selection.getRange(),f=d.startContainer;f.parentNode}if(13===c){var d=e.selection.getRange(),f=d.startContainer;if(null==f)return;var g=baidu.editor.dom.domUtils.findParentByTagName(f,"span",!0);if(null==g)return;var h=g.parentNode;if(null==h)return;var i=h.getAttribute("mini-model");if(null!=i)return console.log("不允许输入回车！"),b.preventDefault?b.preventDefault():b.returnValue=!1,void b.stopPropagation()}}),e.addListener("keyup",function(a,b){b.keyCode||b.which}),e.addListener("selectionchange",function(){for(var a=["anchor","autosubmit","autotypeset","bold","italic","subscript","superscript","blockquote","cleardoc","touppercase","tolowercase","customstyle","directionality","forecolor","backcolor","fontsize","fontfamily","underline","strikethrough","fontborder","formatmatch","horizontal","imagefloat","insertimage","indent","insertcode","inserthtml","insertparagraph","justify","lineheight","link","unlink","insertorderedlist","insertunorderedlist","music","pagebreak","paragraph","preview","print","pasteplain","removeformat","rowspacing","selectall","source","time","date","undo","redo","insertvideo","webapp"],b=-1;b++<a.length-1;){var c=e.queryCommandState(a[b]),d=$("div[name='"+a[b]+"']");switch(a[b]){case"fontsize":var f=e.queryCommandValue(a[b]);$("#fontsize").val(f);break;case"fontfamily":var f=e.queryCommandValue(a[b]);$("#fontfamily").val(f);break;default:switch(c){case-1:d.addClass("control-disabled"),d.removeClass("control-used");break;case 0:d.removeClass("control-disabled"),d.removeClass("control-used");break;case 1:d.addClass("control-used"),d.removeClass("control-disabled")}c?(d.addClass("control-used"),d.removeClass("control-disabled")):c||(d.removeClass("control-disabled"),d.removeClass("control-used"))}}}),b.editor=e,e.ready(function(){console.log("editor加载完成！"),$(".tab-content-item-panel-content-control, .tab-content-item-panel-content-btn1").click(function(){$(this).attr("cmd-value")?e.execCommand($(this).attr("name"),$(this).attr("emr-value")):e.execCommand($(this).attr("name"))}),$(".cmd-select").change(function(){e.execCommand($(this).attr("name"),$(this).val())}),b.model(b.modelType)})},getControlById:function(a){var b=[];if(a){var c=$("#ueditor_0").contents().find("#"+a);c.length>0&&b.push(new MiniControl(c[0]))}else $("#ueditor_0").contents().find(".emr-ctrl").each(function(){b.push(new MiniControl(this))});return b},getControlByDom:function(a){return a?new MiniControl(a):null},execCommand:function(a){this.editor.execCommand(a)},getContent:function(){return this.editor.getContent()},setContent:function(a){return this.editor.setContent(a)},setCacheContent:function(a){this.cacheContent=a},getCacheContent:function(){return this.cacheContent?this.cacheContent:this.getContent()},restoreCacheContent:function(){this.setContent(this.getCacheContent()),this.setTraceFlag("2"),this.model(this.getDefaultModelType()),this.restoreCtrlsValue()},setTraceFlag:function(a){this.traceFlag=a},getTraceFlag:function(){return this.traceFlag},saveCtrlsValue:function(a,b){var c=this,d=c.getControlById();c.ctrlsValue={},$.each(d,function(a,b){1!==b.getOpt().saveFlag&&(c.ctrlsValue[b.getCtrlId()]=b.getValue())})},restoreCtrlsValue:function(){for(var a in this.ctrlsValue){var b=this.getControlById(a);b.length>0&&b[0].setValue(this.ctrlsValue[a]?this.ctrlsValue[a]:"")}},inserthtml:function(a){this.editor.execCommand("inserthtml",a)},model:function(a){if(!a)return this.modelType;var b,c=$("#ueditor_0"),d=c.contents(),e=this.getControlById(),f=[];switch($.each(e,function(a,b){"clickarea"===b.getTypeName()&&b.hasCtrols()&&f.push(b)}),a){case"design":this.modelType=a,d.find(".view, .emr-value").each(function(){$(this).attr("contenteditable",!0)}),d.find(".header, .footer").each(function(){$(this).attr("contenteditable",!0),$(this).children().attr("contenteditable",!0)}),d.find(".view > p").each(function(){$(this).attr("contenteditable",!0)}),d.find(".view > table").each(function(){$(this).attr("contenteditable",!0),$(this.firstChild).attr("contenteditable",!0)}),d.find(".ctrl-hide").each(function(){$(this).show()}),d.find('input[type="radio"], input[type="checkbox"]').each(function(){$(this).removeAttr("disabled")}),d.find("input").each(function(){$(this).removeAttr("readonly")}),$.each(f,function(a,b){b.getValueElement().setAttribute("contenteditable",!0)}),c[0].contentWindow.refreshListener&&c[0].contentWindow.refreshListener();break;case"edit":this.modelType=a,d.find(".view, .header, .footer").each(function(){$(this).attr("contenteditable",!0)}),d.find(".view > p").each(function(){$(this).attr("contenteditable",!0)}),d.find(".emr-value").each(function(){b=new MiniControl(this.parentNode),"1"!==b.getOpt().mode?$(this).attr("contenteditable",!1):$(this).attr("contenteditable",!0)}),d.find(".ctrl-hide").each(function(){$(this).hide()}),d.find('input[type="radio"], input[type="checkbox"]').each(function(){$(this).removeAttr("disabled")}),d.find("input").each(function(){$(this).removeAttr("readonly")}),$.each(f,function(a,b){b.getValueElement().setAttribute("contenteditable",!1)}),c[0].contentWindow.refreshListener&&c[0].contentWindow.refreshListener();break;case"strict":this.modelType=a,d.find(".view > p").each(function(){$(this).attr("contenteditable",!1)}),d.find(".header, .footer").each(function(){$(this).attr("contenteditable",!1),$(this).children().attr("contenteditable",!1)}),d.find(".emr-value").each(function(){b=new MiniControl(this.parentNode),"1"!==b.getOpt().mode||1===b.getOpt().inputFlag?$(this).attr("contenteditable",!1):$(this).attr("contenteditable",!0)}),d.find(".view > table").each(function(){$(this).attr("contenteditable",!1),$(this.firstChild).attr("contenteditable","false")}),d.find(".ctrl-hide").each(function(){$(this).hide()}),d.find('input[type="radio"], input[type="checkbox"]').each(function(){$(this).removeAttr("disabled")}),d.find("input").each(function(){$(this).removeAttr("readonly")}),$.each(f,function(a,b){b.getValueElement().setAttribute("contenteditable",!1)}),c[0].contentWindow.refreshListener&&c[0].contentWindow.refreshListener();break;case"readonly":case"print":this.modelType=a,d.find(".view, .emr-value").each(function(){$(this).attr("contenteditable",!1)}),d.find(".header, .footer").each(function(){$(this).attr("contenteditable",!1),$(this).children().attr("contenteditable",!1)}),d.find(".view > p").each(function(){$(this).attr("contenteditable",!1)}),d.find(".ctrl-hide").each(function(){$(this).hide()}),d.find("input").each(function(){$(this).attr("readonly","readonly")}),d.find(".view > table").each(function(){$(this).attr("contenteditable",!1),$(this.firstChild).attr("contenteditable","false")}),this.saveCtrlsValue(),this.setCacheContent(this.getContent()),this.setContent(this.getCacheContent())}this.isReady=1,this.fireEvent("ready")},getControlByCursor:function(){var a=this.editor.selection.getRange();a.select();for(var b=a.startContainer;b&&!(b.className&&b.className.indexOf("emr-ctrl")>-1);)"BODY"===b.nodeName&&layer.msg("请选择控件内插入数据",{icon:2}),b=b.parentNode;return b&&this.getControlById(b.id).length>0?this.getControlById(b.id)[0]:null},getSelectText:function(){var a=this.editor.selection.getRange();return a.select(),this.editor.selection.getText()},validateForm:function(){for(var a=this.getControlById(),b=[],c=0;c<a.length;c++){var d=a[c].getOpt();if(1!==d.saveFlag){var e={};if("1"===d.mode&&(d.required&&1===d.required||"edittable"===d.type)){var f=a[c].getValue(!0),g=!0;switch(d.type){case"text":case"date":""===f&&(g=!1);break;case"radio":case"checkbox":case"select":0===f.length&&(g=!1);break;case"edittable":var h=a[c].getValueElement(),i=d.fieldName.split(",");$(h).children().each(function(a,c){if(d.rowsNum>a)return!0;for(var f=0,g=i.length;f<g;f++)for(var h=i[f],j=h.split("/"),k=0,l=j.length;k<l;k++){var m=$(this).find(".emr-ctrl#"+j[k]),n=m.length>0?new MiniControl(m[0]):"";if(n){var o=n.getOpt(),p=n.getValue();if(1===o.required&&(!p||0===p.length||$.isEmptyObject(p)?(e={},e.id=n.getCtrlId(),e.desc=o.desc,e.type="1",b.push(e),$(n.getDom()).addClass("validate-fail")):$(n.getDom()).removeClass("validate-fail")),"text"===o.type&&o.verify&&p){var q=new RegExp(o.verify);q.test(p)?$(n.getDom()).removeClass("validate-fail"):(e={},e.id=n.getCtrlId(),e.desc=o.desc,e.type="2",b.push(e),$(n.getDom()).addClass("validate-fail"))}}}})}g?$(a[c].getDom()).removeClass("validate-fail"):(e={},e.id=a[c].getCtrlId(),e.desc=d.desc,e.type="1",b.push(e),$(a[c].getDom()).addClass("validate-fail"))}}}if(b.length>0){for(var j=[],k=[],l="您",c=0;c<b.length;c++)"1"===b[c].type?j.push(b[c].desc):k.push(b[c].desc);return j.length>0&&(l=l+"共有"+j.length+"个必填项未填写，分别是："+j.join("，")+"；"),k.length>0&&(l=l+"共有"+k.length+"个数据格式不正确，分别是："+k.join("，")+"。"),layer.msg(l,{icon:2}),!1}return!0},getParams:function(){var a=this.getControlById(),b={};return $.each(a,function(a,c){var d=c.getCtrlId(),e="",f=c.getOpt();if("select"===c.getTypeName()||"checkbox"===c.getTypeName()||"radio"===c.getTypeName()){var g=[];if(!c.getValue(!0))return;for(var h=0;h<c.getValue(!0).length;h++)g.push(c.getValue(!0)[h].value);e=g.join(",")}else e=c.getValue(!0);var i=d.split("_");if(2===i.length){if(!i[0])return!0;var j=b[i[0]]?b[i[0]]:{};if(!i[1])return!0;if(b[i[0]]=j,"EmrPatientOtherData"===i[0])j[i[1]]=[e,c.getTypeName(),c.getOpt().dataElementId];else if("text"===c.getTypeName()&&f.fieldName)for(var k=f.fieldName.split(","),h=0;h<k.length;h++)j[k[h]]=e[k[h]];else j[i[1]]=e}}),b},setTrace:function(){var a=this;return a.options.patientHospitalEmrId?(a.setTraceFlag("1"),void axios(a.options.traceUrl+a.options.patientHospitalEmrId+"&traceFlag=1").then(function(b){var c=b.data;if(c){a.model("readonly"),a.restoreCtrlsValue();for(var d in c){var e=a.getControlById(d);if(0!==e.length){var f=e[0].getValueElement();"text"===e[0].getTypeName()&&!e[0].getOpt().fieldName||"clickarea"===e[0].getTypeName()?e[0].setValue(c[d],void 0,"1"):f.setAttribute("title",c[d])}}}document.getElementById("ueditor_0").contentWindow.traceListener()})["catch"](function(a){console.error(a),alert("请求数据失败："+a)})):void layer.msg("电子病历还未保存，不存在留痕信息")},setOpt:function(a){for(var b in a)this.options[b]=a[b]},getOpt:function(a){return a?this.options[a]:this.options}},UE.utils.inherits(a,UE.EventBase)}();