/*! cloud_his 2020-08-10 */
!function(a,b){function c(b,c){function e(){$("#btn_save").click(function(){for(var a=d.getControlById(),b={},c=0;c<a.length;c++){var e=a[c].getCtrlId(),f=a[c].getOpt();if(/^[A-Z][A-z0-9]*$/.test(e)&&(e.indexOf("EmrPatientOtherData")<0&&e.indexOf("EmrPatientDicData")<0&&(b[e.substring(0,e.indexOf("_")>0?e.indexOf("_"):e.length)]=1),f.initField))for(var h=f.initField.split(","),i=0,j=h.length;i<j;i++)h[i].indexOf("EmrPatientOtherData")<0&&h[i].indexOf("EmrPatientDicData")<0&&(b[h[i].substring(0,h[i].indexOf("_")>0?h[i].indexOf("_"):h[i].length)]=1)}var k=[];for(var l in b)k.push(l);g.baseFormParams.emrTlpClassId=k.join(","),g.baseFormParams.emrTlpContent=d.getContent(),$.post(g.saveUrl,g.baseFormParams,function(a){"0"===a.code?common.msg(a.msg,1):common.alert(a.msg,2)},"json")}),d.editor.addListener("afterExecCommand",function(a,b){"autosubmit"===b&&$("#btn_save").click()}),d.editor.addshortcutkey({minitemplate:"ctrl+79"})}function f(){console.log(g.initData);for(var a=d.getControlById(),b=0;b<a.length;b++)if(!a[b].hasCtrols()||"edittable"===a[b].getTypeName()){var e,f=$(a[b].getCtrlElement()).attr("id"),h=a[b].getOpt(),i=f.split("_"),j=i[0],k=i[1],l=g.initData[j];if(!l||k&&!l[k]&&0!==l[k]){if(!h.initField){"print"===c.modelType&&(console.log(a[b].getDom()),$(a[b].getDom()).remove());continue}for(var m=h.initField.split(","),n=[],o=0,p=m.length;o<p;o++){var q=m[o].split("_");if(2===q.length){var r=g.initData[q[0]];if(r)if(Array.isArray(r))for(var s=0,t=r.length;s<t;s++)n[o]=n[o]?n[o]+(s+1)+"、"+r[s][q[1]]:s+1+"、"+r[s][q[1]];else n[o]=r[q[1]]?r[q[1]]:"";else n[o]=""}}if(h.fieldName){e={};for(var u=h.fieldName.split(","),v=0,w=u.length;v<w;v++)e[u[v]]=n[v]?n[v]:""}else e=n[0];if(""===e){"print"===c.modelType&&(console.log(a[b].getDom()),$(a[b].getDom()).remove());continue}}else if(Array.isArray(l))if(i.length<2)e=l;else{for(var x=[],o=0,p=l.length;o<p;o++)x.push(l[o].hasOwnProperty(k)?l[o][k]:"");e=x.join(",")}else if(h.fieldName){var u=h.fieldName.split(",");e={};for(var v=0,w=u.length;v<w;v++)e[u[v]]=l[u[v]]?l[u[v]]:"";c.doctorSign&&c.doctorSign>=h.signLevel&&(e.signFlag="1")}else e=l.hasOwnProperty(k)?l[k]:l;if(e||0===l[k])switch(a[b].getTypeName()){case"text":a[b].setValue(e,!0);break;case"clickarea":case"select":a[b].setValue(e,!0);break;case"date":e&&a[b].setValue(e,!0);break;case"checkbox":case"radio":a[b].setValue(e,!0);break;case"list":a[b].setValue(e,!0);break;case"clicktable":a[b].setValue(e,!0);break;case"edittable":console.log(e),a[b].setValue(e,!0,"",c.manageNurseFlag);break;case"medicalformula":a[b].setValue(e,!0);break;default:a[b].setValue(e,!0)}else"print"===c.modelType&&(console.log(a[b].getDom()),$(a[b].getDom()).remove())}var y=document.getElementById("ueditor_0").contentWindow.refreshListener;y&&document.getElementById("ueditor_0").contentWindow.refreshListener("",{type:"medicalformula"})}var g=this;if(this.saveUrl=c.saveUrl,this.initData=c.initData,this.hospitalName=c.hospitalName,this.baseFormParams=c.baseFormParams,this.dicEmrClassNameKeyField=c.dicEmrClassNameKeyField,this.emrTlpClassifyId=c.emrTlpClassifyId,this.rootUrl=c.rootUrl,this.doctorSign=c.doctorSign,!b)return null;this.initData&&this.dicEmrClassNameKeyField&&(this.baseFormParams||(this.baseFormParams={}),$.each(this.initData,function(a,b){var c=g.dicEmrClassNameKeyField[a];c&&b[c]&&(g.baseFormParams[a]||(g.baseFormParams[a]={}),g.baseFormParams[a].id=b[c])}));var h={wordCount:!1,allowDivTransToP:!1,elementPathEnabled:!1,autoClearinitialContent:!1,printType:c.printType};"design"!==c.modelType&&(h.toolbars=[]);var i=this.baseFormParams.PatientHospitalEmr&&this.baseFormParams.PatientHospitalEmr.patientHospitalEmrId?this.baseFormParams.PatientHospitalEmr.patientHospitalEmrId:"";d=a.miniEditor=this.miniEditor=new MiniEditor({id:b,modelType:c.modelType?c.modelType:"design",outhtmlWidth:c.outhtmlWidth?c.outhtmlWidth:"800px",height:c.outhtmlHeight?c.outhtmlHeight:"",fontSize:c.fontSize,footerFlag:"2"!==c.emrTlpClassifyId,editor:h,patientHospitalEmrId:i,traceUrl:c.rootUrl+"/patientHospitalEmrTrace/getEmrTrace.jo?patientHospitalEmrId="}),d.ready(function(){if(d.getTraceFlag())return void console.log("留痕不刷新数据");if(console.log("ready"),$("#hospitalName",$("#ueditor_0").contents()).html(g.hospitalName),"design"===c.modelType)e();else{f();var a=document.getElementById("ueditor_0").contentWindow.refreshListener;"readonly"===c.modelType&&a&&document.getElementById("ueditor_0").contentWindow.refreshListener(c.modelType)}$("#"+b).show(),layui.use(["layer"],function(){var a=layui.layer;a.closeAll()}),"print"===c.modelType&&(console.log($("#ueditor_0").contents().find("body")),$("#ueditor_0").contents().find("body").addClass("print").height("auto"),$("#ueditor_0").contents().find("html").height("auto"))})}var d;c.prototype.setContent=function(a){return d.setContent(a)},c.prototype.getContent=function(){return d.getContent()},c.prototype.setValue=function(a){return d.getControlById(a.id).setValue(a.value,!0)},c.prototype.getValue=function(a){var b="";return d.getControlById(a).length>0&&(b=d.getControlById(a)[0].getValue()),b},c.prototype.getBaseParams=function(){return this.baseFormParams},c.prototype.addParams=function(a){$.extend(this.baseFormParams,a)},c.prototype.save=function(a,b){if("1"===this.miniEditor.getTraceFlag())return void common.msg("留痕模式不能保存",2);var c=this.baseFormParams,e=[],f=d.getControlById(),g=this;if(!this.miniEditor.validateForm())return void(g.saveSuccess&&g.saveSuccess({}));$.each(f,function(a,b){var d=b.getDom().id,f=b.getValue(),g=b.getOpt();if("1"==g.saveFlag)return!0;var h=b.getTypeName(),i="",j="",k=d.split("_");if(!k||k[0].search("[^0-9a-zA-Z_]")>=0)return!0;if("select"===h||"checkbox"===h||"radio"===h){for(var l=[],m=[],a=0;a<f.length;a++)m.push(f[a].value),l.push(f[a].label);j=m.join(","),i=l.join(",")}else{if("list"===h)return!0;j=f}if(1===k.length)k[0]&&j&&(c[k[0]]?$.extend(c[k[0]],j):c[k[0]]=j);else if(2===k.length){if(!k[0])return!0;var n=c[k[0]]?c[k[0]]:{};if(!k[1])return!0;switch(c[k[0]]=n,k[0]){case"EmrPatientOtherData":if("text"===h&&g.fieldName){var o=g.fieldName.split(",");j=f[o[0]]}var p={patientOtherDataId:$(b.getCtrlElement()).attr("patientOtherDataId")?$(b.getCtrlElement()).attr("patientOtherDataId"):"",dataElementId:g.dataElementId,elementName:g.elementName,elementEnName:g.elementEnName,tempValue:j};n[k[1]]=p;break;case"EmrPatientDicData":n[k[1]]=f;break;default:if("text"===h)if(g.fieldName&&f){for(var o=g.fieldName.split(","),a=0;a<o.length;a++)n[o[a]]=f[o[a]];j=f[o[0]]}else n[k[1]]=j;else n[k[1]]=j}if("text"===h||"radio"===h||"select"===h||"date"===h||"checkbox"===h||"clickarea"===h&&!b.hasCtrols()){var q=b.getOldValue(),r=j,s=j;"date"===h&&q&&(q=new Date(parseInt(q)).Format(b.getOpt().format),s=r=new Date(j).Format(b.getOpt().format)),"EmrPatientOtherData"==k[0]||"EmrPatientDicData"==k[0]||"radio"!==h&&"select"!==h&&"checkbox"!==h||(s=i,n[k[1]+"Name"]=i),q===r||g.formulaFlag||e.push({ctrlId:d,ctrlValue:s,ctrlType:g.type,traceFlag:"text"!==h||g.fieldName?"0":"1",oldValue:j})}}});for(var h in c)"{}"===JSON.stringify(c[h])&&delete c[h];c.traceContent=e,c.PatientHospitalEmr&&(c.PatientHospitalEmr.emrHtmlContent=this.miniEditor.getContent()),console.log(c);var i=a?a:g.saveUrl,j=layer.load(1);$.post(i,{emrJsonData:JSON.stringify(c)},function(a){if(layer.close(j),"0"===a.code){g.miniEditor.setOpt({patientHospitalEmrId:a.data.PatientHospitalEmr_patientHospitalEmrId}),$("#patientHospitalEmrId").val(a.data.PatientHospitalEmr_patientHospitalEmrId);for(var c in a.data){var d=g.miniEditor.getControlById(c);d.length>0&&(d[0].setCtrlDataIds(a.data[c]),delete a.data[c])}common.msg("已保存",1,function(){for(var b=0;b<e.length;b++){var c=g.miniEditor.getControlById(e[b].ctrlId);c[0].setOldValue(e[b].oldValue)}g.saveSuccess&&g.saveSuccess(a)}),b&&b(a)}else console.log(layer),layer.alert(a.msg?a.msg:"系统异常",{icon:2})},"json").error(function(a){layer.close(j),layer.alert(a.msg?a.msg:"系统异常",{icon:2})})},a.minieditorDesign=c}(window,document);